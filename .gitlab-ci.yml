# cspell:ignore codequality Micheh micheh webide testdox updatedb stylelintrc fastzip phpcscache Ksection drupaltestbot drupaltestbotpw Dwebdriver logfile XVFB

################
# Drupal GitLabCI template.
#
# Based off GitlabCI templates project: https://git.drupalcode.org/project/gitlab_templates
# Guide: https://www.drupal.org/docs/develop/git/using-gitlab-to-contribute-to-drupal/gitlab-ci
#
# With thanks to:
# - The GitLab Acceleration Initiative participants
# - DrupalSpoons
################

include: '.gitlab-ci/php.yml'

################
# Workflow
#
# Define conditions for when the pipeline will run.
#   For example:
#     * On commit
#     * On merge request
#     * On manual trigger
#     * etc.
# https://docs.gitlab.com/ee/ci/jobs/job_control.html#specify-when-jobs-run-with-rules
#
# Pipelines can also be configured to run on a schedule,though they still must meet the conditions defined in Workflow and Rules. This can be used, for example, to do nightly regression testing:
# https://gitlab.com/help/ci/pipelines/schedules
################

workflow:
  rules:
  # These 3 rules from https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Workflows/MergeRequest-Pipelines.gitlab-ci.yml
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    # Run when called from an upstream pipeline https://docs.gitlab.com/ee/ci/pipelines/downstream_pipelines.html?tab=Multi-project+pipeline#use-rules-to-control-downstream-pipeline-jobs
    - if: $CI_PIPELINE_SOURCE == 'pipeline'
    # Run when called from a parent pipeline
    - if: $CI_PIPELINE_SOURCE == 'parent_pipeline'
    # Run on commits.
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    # The last rule above blocks manual and scheduled pipelines on non-default branch. The rule below allows them:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    # Run if triggered from Web using 'Run Pipelines'
    - if: $CI_PIPELINE_SOURCE == "web"
     # Run if triggered from WebIDE
    - if: $CI_PIPELINE_SOURCE == "webide"

################
# Variables
#
# Overriding variables
# - To override one or more of these variables, simply declare your own variables keyword.
# - Keywords declared directly in .gitlab-ci.yml take precedence over include files.
# - Documentation:  https://docs.gitlab.com/ee/ci/variables/
# - Predefined variables: https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
#
################

variables:
  FF_USE_FASTZIP: 1
  FF_NETWORK_PER_BUILD: 1
  _CONFIG_DOCKERHUB_ROOT: "registry.gitlab.com/drupal-infrastructure/drupalci/drupalci-environments"
  # Let composer know what self.version means.
  COMPOSER_ROOT_VERSION: dev-main
  COMPOSER_ALLOW_SUPERUSER: 1
  CONCURRENCY: 24
  GIT_DEPTH: "50"
  # PHPStan, ESLint and Stylelint store absolute paths in caches.
  # Setting GIT_CLONE_PATH forces a consistent working directory,
  # and on Kubernetes there is no risk of conflict between jobs.
  GIT_CLONE_PATH: $CI_BUILDS_DIR
  PHPUNIT_CONFIGURATION_FILE_PATH: $CI_PROJECT_DIR/core
  PHPUNIT_FAIL_ON_PHPUNIT_DEPRECATION: true
  _TARGET_PHP: "${PRIMARY_PHP}"
  _TARGET_DB: "mysql-8.4"
  _TARGET_DB_DRIVER: "mysql"
  _TARGET_DB_DRIVER_MODULE: "mysql"
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: mysql
  MYSQL_USER: drupaltestbot
  MYSQL_PASSWORD: drupaltestbotpw
  POSTGRES_DB: drupaltestbot
  POSTGRES_USER: drupaltestbot
  POSTGRES_PASSWORD: drupaltestbotpw
  SIMPLETEST_BASE_URL: http://localhost/subdirectory
  MINK_DRIVER_ARGS_WEBDRIVER: '["chrome", {"browserName":"chrome", "goog:chromeOptions":{"w3c": true, "args":["--no-sandbox","--ignore-certificate-errors", "--allow-insecure-localhost", "--headless", "--dns-prefetch-disable"]}}, "http://selenium:4444"]'
  SELENIUM_JAVA_OPTS: "-Dwebdriver.chrome.logfile=/builds/chromedriver.log"
  # Use local cache for yarn, see .yarn-install-from-cache.
  YARN_ENABLE_GLOBAL_CACHE: false
  YARN_ENABLE_MIRROR: false

#############
# Stages    #
#############
stages:
  - ü™Ñ Lint
  - ‚ö°Ô∏è Tests
  - üóúÔ∏è Additional tests

#############
# Defaults  #
#############

default:
  interruptible: true
  retry:
    max: 2
    when:
      - unknown_failure
      - api_failure
      - stuck_or_timeout_failure
      - runner_system_failure
      - scheduler_failure
  image:
    name: $_CONFIG_DOCKERHUB_ROOT/php-$_TARGET_PHP-apache:production

#############
# Templates #
#############

.with-composer: &with-composer
  needs:
    - job: 'üßπ PHP Coding standards (PHPCS)'
      optional: true
    - job: 'üì¶ Composer'
      optional: true

.with-database: &with-database
  name: $_CONFIG_DOCKERHUB_ROOT/$_TARGET_DB:production
  alias: database

.with-selenium-chrome: &with-selenium-chrome
  name: selenium/standalone-chrome:127.0
  alias: selenium
  variables:
    JAVA_OPTS: $SELENIUM_JAVA_OPTS
    SE_NODE_OVERRIDE_MAX_SESSIONS: "true"
    SE_NODE_MAX_SESSIONS: "16"
    SE_SESSION_RETRY_INTERVAL: "1"
    SE_SESSION_REQUEST_TIMEOUT: "60"
    SE_START_XVFB: "true"
    SE_START_VNC: "false"

.default-job-settings-lint: &default-job-settings-lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $PERFORMANCE_TEST != "1"

.composer-setup: &composer-setup
  - echo -e "\e[0Ksection_start:`date +%s`:composer_setup[collapsed=true]\r\e[0K\e[0;30;103m*** Composer setup ***\e[0m"
  - composer validate
  - composer install --optimize-autoloader
  - composer run-script drupal-phpunit-upgrade-check
  - echo -e "\e[0Ksection_end:`date +%s`:composer_setup\r\e[0K"

.download-cache: &download-cache
  - |
    if [[ "$CI_MERGE_REQUEST_LABELS" =~ "Test lint cache warming" ]]; then
      CACHE_URL=https://git.drupalcode.org/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}/raw/${CACHE_FILE}?job=Write%20lint%20caches
    else
      CACHE_URL=https://git.drupalcode.org/api/v4/projects/project%2Fdrupal/jobs/artifacts/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}${CI_COMMIT_BRANCH}/raw/${CACHE_FILE}?job=Write%20lint%20caches
    fi
  # Get the cache file from the artifacts of the latest successful job from the
  # target branch. Allow the job to proceed and pass if the file doesn't exist.
  - echo Downloading $CACHE_URL
  - curl --fail --location --create-dirs --output $CACHE_FILE "$CACHE_URL" || true

.core-spellcheck: &core-spellcheck
  - cd core
  - echo -e "Node version $(node --version)\nYarn version $(yarn --version)"
  - yarn run spellcheck:core --no-progress --no-must-find-files --cache --cache-strategy content

.yarn-install-from-cache: &yarn-install-from-cache
  before_script:
    - cd core
    - corepack enable
    - yarn install
    - cd ..
  cache:
    key:
      files:
        - ./core/package.json
        - ./core/yarn.lock
    paths:
      - ./core/.yarn/cache
    policy: pull

.test-setup: &test-setup
  stage: ‚ö°Ô∏è Tests
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline" && $PERFORMANCE_TEST != "1"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
      allow_failure: true
  before_script:
    - |
      [[ $_TARGET_DB == sqlite* ]] && export SIMPLETEST_DB=sqlite://localhost/$CI_PROJECT_DIR/sites/default/files/db.sqlite?module=sqlite
      [[ $_TARGET_DB == mysql* ]] && export SIMPLETEST_DB=$_TARGET_DB_DRIVER://$MYSQL_USER:$MYSQL_PASSWORD@database/$MYSQL_DATABASE?module=$_TARGET_DB_DRIVER_MODULE
      [[ $_TARGET_DB == mariadb* ]] && export SIMPLETEST_DB=$_TARGET_DB_DRIVER://$MYSQL_USER:$MYSQL_PASSWORD@database/$MYSQL_DATABASE?module=$_TARGET_DB_DRIVER_MODULE
      [[ $_TARGET_DB == pgsql* ]] && export SIMPLETEST_DB=pgsql://$POSTGRES_USER:$POSTGRES_PASSWORD@database/$POSTGRES_DB?module=pgsql
    - echo "SIMPLETEST_DB = $SIMPLETEST_DB"
    - export PHPUNIT_CONFIGURATION_FILE_PATH=$CI_PROJECT_DIR/core
    - $CI_PROJECT_DIR/.gitlab-ci/scripts/server-setup.sh
  script:
    - sudo -u www-data -E -H composer run-script drupal-phpunit-upgrade-check
    # Need to pass this along directly.
    - sudo -u www-data -E -H php ./core/scripts/run-tests.sh --phpunit-configuration $PHPUNIT_CONFIGURATION_FILE_PATH --debug-discovery --color --keep-results --types "$TESTSUITE" --concurrency "$CONCURRENCY" --repeat "1" --sqlite ":memory:" --dburl $SIMPLETEST_DB --url $SIMPLETEST_BASE_URL --verbose --non-html --all --ci-parallel-node-index $CI_NODE_INDEX --ci-parallel-node-total $CI_NODE_TOTAL
  after_script:
    - sed -i "s#$CI_PROJECT_DIR/##" ./sites/default/files/simpletest/phpunit-*.xml || true
  artifacts:
    when: always
    expire_in: 6 mos
    reports:
      junit: ./sites/default/files/simpletest/phpunit-*.xml
    paths:
      - ./sites/default/files/simpletest/phpunit-*.xml
      - ./sites/simpletest/browser_output
      - '*.log'

################
# Stages
#
# Each job is assigned to a stage, defining the order in which the jobs are executed.
# Jobs in the same stage run in parallel.
#
# If all jobs in a stage succeed, the pipeline will proceed to the next stage.
# If any job in the stage fails, the pipeline will exit early.
################

.recursive-trigger: &recursive-trigger
  stage: üóúÔ∏è Additional tests
  trigger:
    # Rely on the status of the child pipeline.
    strategy: depend
    include: .gitlab-ci.yml

.run-on-commit: &run-on-commit
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
      allow_failure: true

.run-daily: &run-daily
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_ROOT_NAMESPACE == "project" && $DAILY_TEST == "1"
      allow_failure: true

.run-on-mr: &run-on-mr
  needs: [ 'üßπ PHP Coding standards (PHPCS)' ]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true

################
# Composer Job
################

'üì¶ Composer':
  stage: ü™Ñ Lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
  needs: []
  script:
    - *composer-setup
    - if [ -n "$COMPOSER_UPDATE" ]; then
        composer update --optimize-autoloader;
        composer outdated;
      fi
  artifacts:
    expire_in: 1 week
    paths:
      - vendor/
      - composer.lock
      - composer/Metapackage/

##################
# Unit test Jobs
##################

'üìã PHPUnit Unit (Core)':
  stage: ‚ö°Ô∏è Tests
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $PERFORMANCE_TEST != "1"
  needs: []
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
  allow_failure:
    # It's not possible to set allow failure conditional on a possible value of
    # the matrix, so we intercept failure from the script and exit with a code
    # that we allow here.
    exit_codes: 100
  variables:
    KUBERNETES_CPU_REQUEST: "4"
    CONCURRENCY: 24
    PHPUNIT_FAIL_ON_PHPUNIT_DEPRECATION: true
  before_script:
    - *composer-setup
    - mkdir -p ./sites/simpletest ./sites/default/files ./build/logs/junit /var/www/.composer
    - chown -R www-data:www-data ./sites ./build/logs/junit ./vendor /var/www/
  script:
    - sudo -u www-data -E -H php ./core/scripts/run-tests.sh --color --keep-results --types "PHPUnit-Unit" --concurrency "$CONCURRENCY" --repeat "1" --sqlite ":memory:" --verbose --non-html --all || EXIT_CODE=$?
    # Allow failure for the next PHP major.
    - |
      [[ $EXIT_CODE != 0 && $_TARGET_PHP == $NEXT_PHP_MAJOR ]] && exit 100
    - exit $EXIT_CODE
  after_script:
    - sed -i "s#$CI_PROJECT_DIR/##" ./sites/default/files/simpletest/phpunit-*.xml || true
  artifacts:
    when: always
    expire_in: 6 mos
    reports:
      junit: ./sites/default/files/simpletest/phpunit-*.xml
    paths:
      - ./sites/default/files/simpletest/phpunit-*.xml

'üìã PHPUnit Unit (Component)':
  # Jobs that produce metrics must run on performance test pipelines so MRs show
  # the correct information.
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $PERFORMANCE_TEST != "1" || $_TARGET_PHP == $PRIMARY_PHP
  stage: ‚ö°Ô∏è Tests
  needs: []
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
  allow_failure:
    # It's not possible to set allow failure conditional on a possible value of
    # the matrix, so we intercept failure from the script and exit with a code
    # that we allow here.
    exit_codes: 100
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    _ARTIFACTS_DIR: "test-artifacts/phpunit"
    PHPUNIT_FAIL_ON_PHPUNIT_DEPRECATION: true
  before_script:
    - mkdir -p $_ARTIFACTS_DIR
    - *composer-setup
    - |
      [[ $_TARGET_PHP == $PRIMARY_PHP ]] && docker-php-ext-enable pcov
  script:
    # Execute test coverage reporting only for the primary PHP version.
    - |
      [[ $_TARGET_PHP != $PRIMARY_PHP ]] && export _PHPUNIT_COVERAGE=""
      [[ $_TARGET_PHP == $PRIMARY_PHP ]] && export _PHPUNIT_COVERAGE="--coverage-text=$_ARTIFACTS_DIR/component-coverage-report.txt --coverage-cobertura=$_ARTIFACTS_DIR/component-coverage-cobertura.xml"
    - |
      [[ $PHPUNIT_FAIL_ON_PHPUNIT_DEPRECATION == false ]] && export _FAIL_ON_PHPUNIT_DEPRECATION=""
      [[ $PHPUNIT_FAIL_ON_PHPUNIT_DEPRECATION != false ]] && export _FAIL_ON_PHPUNIT_DEPRECATION="--fail-on-phpunit-deprecation"
    # Component tests are run via the PHPUnit CLI using a PHPUnit configuration
    # file of its own located in the core/tests/Drupal/Tests/Component
    # directory.
    - vendor/bin/phpunit -c core/tests/Drupal/Tests/Component --testsuite unit-component --colors=always --testdox --log-junit $_ARTIFACTS_DIR/junit.xml --fail-on-deprecation $_FAIL_ON_PHPUNIT_DEPRECATION $_PHPUNIT_COVERAGE || EXIT_CODE=$?
    # Allow failure for the next PHP major.
    - |
      [[ $EXIT_CODE != 0 && $_TARGET_PHP == $NEXT_PHP_MAJOR ]] && exit 100
    - exit $EXIT_CODE
  after_script:
    # Process the coverage text report to produce an OpenMetrics report.
    - |
      [[ $_TARGET_PHP == $PRIMARY_PHP ]] && php .gitlab-ci/scripts/component-coverage-metrics.php $_ARTIFACTS_DIR/component-coverage-report.txt $_ARTIFACTS_DIR/component-coverage-metrics.txt
  artifacts:
    when: always
    expire_in: 6 mos
    reports:
      junit: $_ARTIFACTS_DIR/junit.xml
      metrics: $_ARTIFACTS_DIR/component-coverage-metrics.txt
      coverage_report:
        coverage_format: cobertura
        path: $_ARTIFACTS_DIR/component-coverage-cobertura.xml
    paths:
      - $_ARTIFACTS_DIR

'üìã PHPUnit Unit (PHPStan rules)':
  stage: ‚ö°Ô∏è Tests
  needs: []
  variables:
    KUBERNETES_CPU_REQUEST: "2"
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    # Run if PHPStan files have changed, or manually.
    - if: $PERFORMANCE_TEST != "1"
      changes:
        - core/tests/PHPStan/**/*
        - composer/Metapackage/PinnedDevDependencies/composer.json
    - when: manual
      allow_failure: true
  script:
    - docker-php-ext-enable pcov
    - cd core/tests/PHPStan
    - composer install
    - vendor/bin/phpunit tests --testdox --coverage-text --colors=always --coverage-cobertura=coverage.cobertura.xml --log-junit junit.xml
  artifacts:
    when: always
    reports:
      junit: core/tests/PHPStan/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: core/tests/PHPStan/coverage.cobertura.xml

################
# Test Jobs
################

'üñ±Ô∏èÔ∏èÔ∏è PHPUnit Functional Javascript':
  <<: [ *with-composer, *test-setup ]
  parallel: 3
  variables:
    TESTSUITE: PHPUnit-FunctionalJavascript
    CONCURRENCY: 5
    KUBERNETES_CPU_REQUEST: "16"
  services:
    - <<: *with-database
    - <<: *with-selenium-chrome
  after_script:
    - sed -i "s#$CI_PROJECT_DIR/##" ./sites/default/files/simpletest/phpunit-*.xml || true
    - cp /builds/chromedriver.log ./

'üë∑Ô∏èÔ∏èÔ∏è PHPUnit Build':
  <<: [ *with-composer, *test-setup ]
  retry: 1
  variables:
    TESTSUITE: PHPUnit-Build
    KUBERNETES_CPU_REQUEST: "8"
    CONCURRENCY: "5"
  services:
    - <<: *with-database

'üåêÔ∏èÔ∏è PHPUnit Functional':
  <<: [ *with-composer, *test-setup ]
  parallel: 8
  variables:
    TESTSUITE: PHPUnit-Functional
    CONCURRENCY: "5"
    KUBERNETES_CPU_REQUEST: "16"
  services:
    - <<: *with-database

'‚öôÔ∏èÔ∏è PHPUnit Kernel':
  <<: [ *with-composer, *test-setup ]
  parallel: 5
  variables:
    TESTSUITE: PHPUnit-Kernel
    KUBERNETES_CPU_REQUEST: "8"
    CONCURRENCY: 12
  services:
    - <<: *with-database

'ü¶âÔ∏èÔ∏èÔ∏è Nightwatch':
  <<: [ *with-composer, *test-setup ]
  retry: 1
  variables:
    KUBERNETES_CPU_REQUEST: "16"
  services:
    - <<: *with-database
    - <<: *with-selenium-chrome
  script:
    - export DRUPAL_TEST_DB_URL=$SIMPLETEST_DB
    - cp ./core/.env.example ./core/.env
    # dotenv-safe/config does not support environment variables
    # @see https://github.com/rolodato/dotenv-safe/issues/126
    # @todo move this to `variables` when the above is resolved
    - echo "DRUPAL_TEST_BASE_URL='http://localhost/subdirectory'" >> ./core/.env
    - echo "DRUPAL_TEST_CHROMEDRIVER_AUTOSTART=false" >> ./core/.env
    - echo "DRUPAL_TEST_DB_URL='${DRUPAL_TEST_DB_URL}'" >> ./core/.env
    - echo "DRUPAL_TEST_WEBDRIVER_HOSTNAME='selenium'" >> ./core/.env
    - echo "DRUPAL_TEST_WEBDRIVER_CHROME_ARGS='--disable-dev-shm-usage --disable-gpu --headless --dns-prefetch-disable'" >> ./core/.env
    - echo "DRUPAL_TEST_WEBDRIVER_W3C=true" >> ./core/.env
    - echo "DRUPAL_TEST_WEBDRIVER_PORT='4444'" >> ./core/.env
    - echo "DRUPAL_NIGHTWATCH_OUTPUT='"../nightwatch_output"'" >> ./core/.env
    - echo "COLUMNS=1000" >> ./core/.env
    - chown -R www-data:www-data ./sites /var/www
    - cd core
    - corepack enable
    - yarn install
    - echo -e "Node version $(node --version)\nYarn version $(yarn --version)"
    - sudo -u www-data -E -H yarn run test:nightwatch --workers=3
  after_script:
    - cp /builds/chromedriver.log ./
  artifacts:
    when: always
    expire_in: 6 mos
    reports:
      junit: ./nightwatch_output/**/*.xml
    paths:
      - ./nightwatch_output
      - '*.log'
  cache:
    key:
      files:
        - ./core/package.json
        - ./core/yarn.lock
    paths:
      - ./core/.yarn/cache
    policy: pull

'üîÅ Repeat Class Test':
  <<: [ *with-composer, *test-setup ]
  stage: üóúÔ∏è Additional tests
  when: manual
  allow_failure: true
  variables:
    REPEAT_TEST_CLASS: 'Drupal\Tests\Change\Me'
    REPEAT_COUNT: 100
  services:
    - <<: *with-database
    - <<: *with-selenium-chrome
  script:
    - echo "‚ÑπÔ∏è Running class ${REPEAT_TEST_CLASS}"
    - |
      if [[ $REPEAT_TEST_CLASS == "Drupal\Tests\Change\Me" ]]; then
        echo '‚ùó You need to change the REPEAT_TEST_CLASS variable to an existing class before running the job.'
        echo '   You just need to click on the job that you want to run (do not press the play button straight away) and then set the following:'
        echo '   "Key" to "REPEAT_TEST_CLASS" and "Value" to "Drupal\Tests\ckeditor5\FunctionalJavascript\MediaLinkabilityTest"';
        exit 1;
      else
        sudo -u www-data -E -H php ./core/scripts/run-tests.sh --phpunit-configuration $PHPUNIT_CONFIGURATION_FILE_PATH --color --keep-results --concurrency "$CONCURRENCY" --repeat "$REPEAT_COUNT" --sqlite ":memory:" --dburl $SIMPLETEST_DB --url $SIMPLETEST_BASE_URL --verbose --non-html --class $REPEAT_TEST_CLASS
      fi

'üö≤ Performance tests':
  <<: [ *test-setup ]
  stage: üóúÔ∏è Additional tests
  rules:
    - if: $PERFORMANCE_TEST == "1"
    - when: manual
      allow_failure: true
  variables:
    KUBERNETES_CPU_REQUEST: "24"
    SELENIUM_JAVA_OPTS: "-Dwebdriver.chrome.logfile=/builds/chromedriver-selenium.log"
  tags:
    - performance-test-runner
  services:
    - <<: *with-database
    - <<: *with-selenium-chrome
  script:
    #  Determine DB driver.
    - |
      [[ $_TARGET_DB == sqlite* ]] && export SIMPLETEST_DB=sqlite://localhost/subdirectory/sites/default/files/db.sqlite?module=sqlite
      [[ $_TARGET_DB == mysql* ]] && export SIMPLETEST_DB=$_TARGET_DB_DRIVER://$MYSQL_USER:$MYSQL_PASSWORD@database/$MYSQL_DATABASE?module=$_TARGET_DB_DRIVER_MODULE
      [[ $_TARGET_DB == mariadb* ]] && export SIMPLETEST_DB=$_TARGET_DB_DRIVER://$MYSQL_USER:$MYSQL_PASSWORD@database/$MYSQL_DATABASE?module=$_TARGET_DB_DRIVER_MODULE
      [[ $_TARGET_DB == pgsql* ]] && export SIMPLETEST_DB=pgsql://$POSTGRES_USER:$POSTGRES_PASSWORD@database/$POSTGRES_DB?module=pgsql
    - composer install --optimize-autoloader
    - export OTEL_COLLECTOR="$OPENTELEMETRY_COLLECTOR"
    - mkdir -p ./sites/simpletest ./sites/default/files ./build/logs/junit /var/www/.composer
    - chown -R www-data:www-data ./sites ./build/logs/junit ./vendor /var/www/
    - sudo -u www-data git config --global --add safe.directory $CI_PROJECT_DIR
    - sudo SIMPLETEST_BASE_URL="http://$HOSTNAME/subdirectory" -u www-data -E -H ./vendor/bin/phpunit --display-all-issues -c core --group OpenTelemetry --log-junit=./sites/default/files/simpletest/phpunit-performance.xml
  after_script:
    - cp /builds/chromedriver-selenium.log ./

################
# Variant trigger jobs
################

# Re-run the pipeline, but with Composer updates.
'Updated dependencies':
  <<: *recursive-trigger
  # Run daily and allow manual runs on MRs.
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_ROOT_NAMESPACE == "project" && $DAILY_TEST == "1"
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
  variables:
    COMPOSER_UPDATE: "1"

# Runs only the tests affected by changes in the MR.
# The name starts with a space to be listed before the other jobs.
' ü©π Test-only changes':
  <<: [ *with-composer, *test-setup ]
  stage: üóúÔ∏è Additional tests
  services:
    - <<: *with-database
    - <<: *with-selenium-chrome
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $PERFORMANCE_TEST != "1"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline" && $PERFORMANCE_TEST != "1"
      when: manual
      allow_failure: true
  script:
    - $CI_PROJECT_DIR/.gitlab-ci/scripts/test-only.sh

# Main listing of jobs. All of these are available on Merge Requests.
'MariaDB (via PDO)':
  <<: [ *recursive-trigger, *run-on-mr ]
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
        _TARGET_DB: [mariadb-10.6]
  variables:
    _TARGET_DB_DRIVER: "mysql"
    _TARGET_DB_DRIVER_MODULE: "mysql"

'MySQL (via PDO)':
  <<: [ *recursive-trigger, *run-on-mr ]
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
        _TARGET_DB: [mysql-8, mysql-8.4, mysql-9]
  variables:
    _TARGET_DB_DRIVER: "mysql"
    _TARGET_DB_DRIVER_MODULE: "mysql"

'MySQL (via mysqli)':
  <<: [ *recursive-trigger, *run-on-mr ]
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
        _TARGET_DB: [mysql-9]
  variables:
    _TARGET_DB_DRIVER: "mysqli"
    _TARGET_DB_DRIVER_MODULE: "mysqli"

'PostgreSQL':
  <<: [ *recursive-trigger, *run-on-mr ]
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
        _TARGET_DB: [pgsql-16, pgsql-17, pgsql-18]

'SQLite':
  <<: [ *recursive-trigger, *run-on-mr ]
  parallel:
    matrix:
      - _TARGET_PHP: !reference [.php_versions]
        _TARGET_DB: [sqlite-3]

# Jobs running on commits.
# The value set in the "needs" property will determine the order in the sequence.
'[Commit] PHP 8.5 PostgreSQL 16':
  <<: [ *recursive-trigger, *run-on-commit ]
  variables:
    _TARGET_PHP: $MINIMUM_PHP
    _TARGET_DB: "pgsql-16"

'[Commit] PHP 8.5 MySQL 9 via mysqli':
  <<: [ *recursive-trigger, *run-on-commit ]
  needs: [ '[Commit] PHP 8.5 PostgreSQL 16' ]
  variables:
    _TARGET_PHP: $MINIMUM_PHP
    _TARGET_DB: "mysql-9"
    _TARGET_DB_DRIVER: "mysqli"
    _TARGET_DB_DRIVER_MODULE: "mysqli"

'[Commit] PHP 8.5 SQLite 3.45':
  <<: [ *recursive-trigger, *run-on-commit ]
  needs: [ '[Commit] PHP 8.5 MySQL 9 via mysqli' ]
  variables:
    _TARGET_PHP: $MINIMUM_PHP
    _TARGET_DB: "sqlite-3"

# Jobs running daily.
# The value set in the "needs" property will determine the order in the sequence.
'[Daily] PHP minimum PostgreSQL 16':
  <<: [ *recursive-trigger, *run-daily ]
  variables:
    _TARGET_PHP: $MINIMUM_PHP
    _TARGET_DB: "pgsql-16"

'[Daily] PHP 8.5 MySQL 9 via mysqli':
  <<: [ *recursive-trigger, *run-daily ]
  needs: [ '[Daily] PHP minimum PostgreSQL 16' ]
  variables:
    _TARGET_PHP: "8.5-ubuntu"
    _TARGET_DB: "mysql-9"
    _TARGET_DB_DRIVER: "mysqli"
    _TARGET_DB_DRIVER_MODULE: "mysqli"

'[Daily] PHP minimum SQLite 3.45':
  <<: [ *recursive-trigger, *run-daily ]
  needs: [ '[Daily] PHP 8.5 MySQL 9 via mysqli' ]
  variables:
    _TARGET_PHP: $MINIMUM_PHP
    _TARGET_DB: "sqlite-3"

'[Daily] MariaDB 10.6':
  <<: [ *recursive-trigger, *run-daily ]
  needs: [ '[Daily] PHP minimum SQLite 3.45' ]
  variables:
    _TARGET_DB: "mariadb-10.6"
    _TARGET_DB_DRIVER: "mysql"
    _TARGET_DB_DRIVER_MODULE: "mysql"

'[Daily] MySQL 9.3':
  <<: [ *recursive-trigger, *run-daily ]
  needs: [ '[Daily] MariaDB 10.6' ]
  variables:
    _TARGET_DB: "mysql-9"
    _TARGET_DB_DRIVER: "mysql"
    _TARGET_DB_DRIVER_MODULE: "mysql"

'[Daily] PostgreSQL 18':
  <<: [ *recursive-trigger, *run-daily ]
  needs: [ '[Daily] MySQL 9.3' ]
  variables:
    _TARGET_DB: "pgsql-18"

################
# Lint Jobs
################

.lint-cache-artifacts: &lint-cache-artifacts
  artifacts:
    paths:
      - core/phpstan-tmp/resultCache.php
      - core/.cspellcache
      - core/.eslintcache
      - core/.stylelintcache
      - core/.phpcscache

# Download the cache artifacts from the previous pipeline run to work around
# https://gitlab.com/gitlab-org/gitlab/-/issues/458828 due to performance
# testing. Note that this job must come before the lint jobs that create the
# updated cache files. This ensures that their updated artifacts are used in the
# 'Write lint caches' job.
'Lint cache download':
  <<: [ *lint-cache-artifacts ]
  stage: ü™Ñ Lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_ROOT_NAMESPACE == "project" && $DAILY_TEST == "1"
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Test lint cache warming/)
    - if: $PERFORMANCE_TEST == "1"
  script:
    - CACHE_FILE=core/phpstan-tmp/resultCache.php
    - *download-cache
    - CACHE_FILE=core/.cspellcache
    - *download-cache
    - CACHE_FILE=core/.eslintcache
    - *download-cache
    - CACHE_FILE=core/.stylelintcache
    - *download-cache
    - CACHE_FILE=core/.phpcscache
    - *download-cache

'üìî Spell-checking':
  <<: [ *yarn-install-from-cache ]
  <<: [ *default-job-settings-lint ]
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    CACHE_FILE: "core/.cspellcache"
  script:
    - *download-cache
    - *core-spellcheck
  artifacts:
    expire_in: 1 week
    expose_as: 'yarn-vendor'
    paths:
      - core/node_modules/
      - core/.cspellcache

'üßπ PHP Static Analysis (phpstan)':
  <<: [ *default-job-settings-lint ]
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "4"
    _ARTIFACTS_DIR: "test-artifacts/phpstan"
    _PHPSTAN_NEON: "core/phpstan.neon.dist"
    _PHPSTAN_BASELINE: "core/.phpstan-baseline.php"
    CACHE_FILE: "core/phpstan-tmp/resultCache.php"
  before_script:
    - *download-cache
    - mkdir -p $_ARTIFACTS_DIR
    - *composer-setup
    - if [ -n "$COMPOSER_UPDATE" ]; then
        composer update --optimize-autoloader;
        composer outdated;
      fi
  script:
    - vendor/bin/phpstan --version
    - php vendor/bin/phpstan -vvv analyze --configuration=$_PHPSTAN_NEON --error-format=multiplex || EXIT_CODE=$?
    # When the PHPStan scan fails, regenerate a full baseline.
    # In order to regenerate a baseline artifact that can be copied and pasted
    # to a MR branch, we first need to void the current baseline file, then
    # run PHPStan with the --generate-baseline option.
    - |
      if [ -n "$EXIT_CODE" ]; then
        # Generate a new baseline.
        echo "Generating a PHPStan baseline file (available as job artifact)."
        cp $CI_PROJECT_DIR/.gitlab-ci/scripts/.empty-phpstan-baseline.php $_PHPSTAN_BASELINE
        php vendor/bin/phpstan analyze --configuration=$_PHPSTAN_NEON --no-progress --generate-baseline=$_PHPSTAN_BASELINE || true
        # Report statistics on the new baseline.
        php $CI_PROJECT_DIR/.gitlab-ci/scripts/phpstan-baseline-statistics.php $_PHPSTAN_BASELINE $_ARTIFACTS_DIR/phpstan-metrics.txt
        # Copy the new baseline to the artifacts directory.
        cp $_PHPSTAN_BASELINE $_ARTIFACTS_DIR/phpstan-baseline.php
        exit $EXIT_CODE
      fi
    # Generate baseline statistics.
    - php $CI_PROJECT_DIR/.gitlab-ci/scripts/phpstan-baseline-statistics.php $_PHPSTAN_BASELINE $_ARTIFACTS_DIR/phpstan-metrics.txt
  artifacts:
    reports:
      codequality: $_ARTIFACTS_DIR/phpstan-gitlab.json
      junit: $_ARTIFACTS_DIR/phpstan-junit.xml
      metrics: $_ARTIFACTS_DIR/phpstan-metrics.txt
    when: always
    paths:
      - $_ARTIFACTS_DIR
      - core/phpstan-tmp/resultCache.php

'üßπ PHP Coding standards (PHPCS)':
  <<: [ *default-job-settings-lint ]
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "4"
    _ARTIFACTS_DIR: "test-artifacts/phpcs"
    CACHE_FILE: "core/.phpcscache"
  before_script:
    - mkdir -p $_ARTIFACTS_DIR
    - *composer-setup
    - if [ -n "$COMPOSER_UPDATE" ]; then
        composer update --optimize-autoloader;
        composer outdated;
      fi
    - mkdir -p $_ARTIFACTS_DIR
    - *download-cache
  script:
    - vendor/bin/phpcs --version
    - composer phpcs -- -s --report-full --report-summary --report-\\Micheh\\PhpCodeSniffer\\Report\\Gitlab=$_ARTIFACTS_DIR/phpcs-quality-report.json --cache=core/.phpcscache
  artifacts:
    reports:
      codequality: $_ARTIFACTS_DIR/phpcs-quality-report.json
    expire_in: 1 week
    expose_as: 'web-vendor'
    paths:
      - vendor/
      - composer.lock
      - composer/Metapackage/
      - $_ARTIFACTS_DIR
      - core/.phpcscache

'üßπ JavaScript linting (eslint)':
  <<: [ *yarn-install-from-cache ]
  # Overwrites the cache key to be the job that pushes the cache. All the other
  # jobs will only pull from the cache.
  cache:
    key: !reference [.yarn-install-from-cache, cache, key]
    paths: !reference [.yarn-install-from-cache, cache, paths]
    policy: pull-push
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    CACHE_FILE: "core/.eslintcache"
  # Run on push, or on MRs if CSS files have changed, or manually.
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - core/.eslint*
        - core/.prettier*
        - core/package.json
        - core/yarn.lock
        - "**/*.js"
        - "**/*.yml"
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Test lint cache warming/)
    - when: manual
      allow_failure: true
  script:
    - *download-cache
    - cd core
    - echo -e "Node version $(node --version)\nYarn version $(yarn --version)"
    - yarn run check:ckeditor5
    - yarn run lint:core-js-passing --cache --cache-strategy content --format gitlab
  artifacts:
    reports:
      codequality: eslint-quality-report.json
    paths:
      - core/.eslintcache

'üßπ CSS linting (stylelint)':
  <<: [ *yarn-install-from-cache ]
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    CACHE_FILE: "core/.stylelintcache"
  # Run on push, or on MRs if CSS files have changed, or manually.
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - core/.stylelintrc.json
        - core/.prettier*
        - core/package.json
        - core/yarn.lock
        - "**/*.css"
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Test lint cache warming/)
    - when: manual
      allow_failure: true
  script:
    - *download-cache
    - cd core
    - echo -e "Node version $(node --version)\nYarn version $(yarn --version)"
    - yarn run build:css --check
    - yarn run lint:css --cache --cache-location .stylelintcache --cache-strategy content --color  --custom-formatter=@gitlab-formatters/stylelint-formatter-gitlab --output-file=$CI_PROJECT_DIR/gl-codequality.json
  artifacts:
    reports:
      codequality: gl-codequality.json
    paths:
      - core/.stylelintcache

'üìî Validatable config':
  <<: [ *default-job-settings-lint ]
  stage: ü™Ñ Lint
  variables:
    KUBERNETES_CPU_REQUEST: "2"
  # Run on MRs if config schema files have changed, or manually.
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - when: manual
      allow_failure: true
  artifacts:
    expire_in: 1 week
    expose_as: 'validatable-config'
    paths:
      - HEAD.json
      - MR.json
  # This job must pass, but must also not disrupt Drupal core's CI if dependencies are not core-compatible.
  allow_failure:
    exit_codes:
      # `composer require ‚Ä¶` fails (implies no version available compatible with Drupal core)
      - 100
      # `drush pm:install config_inspector ‚Ä¶` fails (implies failure during module installation)
      - 101
      # Temporarily allow this to fail as there's are bugs with adding/removing/modifying config schemas.
      - 1
  script:
    # Revert back to the tip of the branch this MR started from.
    - git checkout -f $CI_MERGE_REQUEST_DIFF_BASE_SHA
    # Composer-install Drush & the Config Inspector module.
    - composer require drush/drush drupal/config_inspector || exit 100
    # Install Drupal's Standard install profile + all core modules (except obsolete ones) + the config inspector module.
    - php core/scripts/drupal install standard
    - ls core/modules | grep -v sdc | xargs vendor/bin/drush pm:install --yes
    - vendor/bin/drush pm:install config_inspector --yes --quiet || exit 101
    # Compute statistics for coverage of validatable config for HEAD.
    - vendor/bin/drush config:inspect --statistics > HEAD.json
    # Return to the MR commit being tested, conditionally install updates, always rebuild the container.
    - git checkout -f $CI_COMMIT_SHA
    - git diff $CI_MERGE_REQUEST_DIFF_BASE_SHA $CI_COMMIT_SHA --name-only | grep -q '.install$\|.post_update\.php$' && echo 'ü§ñ Installing DB updates‚Ä¶' && vendor/bin/drush updatedb --yes
    - vendor/bin/drush cr --quiet
    # Compute statistics for coverage of validatable config for MR.
    - vendor/bin/drush config:inspect --statistics > MR.json
    # Output diff, but never fail the job.
    - diff -u HEAD.json MR.json || true
    # Determine if this increased or decreased coverage. Fail the job if it is worse. All the
    # percentages must be equal or higher, with the exception of `typesInUse`.
    - |
      php -r '
         $head = json_decode(file_get_contents("HEAD.json"), TRUE)["assessment"];
         $mr = json_decode(file_get_contents("MR.json"), TRUE)["assessment"];
         unset($head["_description"], $head["typesInUse"], $mr["_description"], $mr["typesInUse"]);
         $impact = array_map(fn (float $h, float $m) => $m-$h, $head, $mr);
         exit((int) (min($impact) < 0));
      '

'üì¶ Yarn install on minimum Node.js version':
  stage: ü™Ñ Lint
  image: node:20
  variables:
    KUBERNETES_CPU_REQUEST: "1"
  # Run on push, or on MRs if package.json or yarn.lock have changed, or manually.
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - core/package.json
        - core/yarn.lock
    - when: manual
      allow_failure: true
  script:
    - cd core
    - corepack enable
    - echo -e "Node version $(node --version)\nYarn version $(corepack yarn --version)"
    - yarn install

# This job should be real quick and run at the very end of the pipeline.
'Write lint caches':
  <<: [ *lint-cache-artifacts ]
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PROJECT_ROOT_NAMESPACE == "project" && $DAILY_TEST == "1"
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Test lint cache warming/)
    - if: $PERFORMANCE_TEST == "1"
  stage: ‚ö°Ô∏è Tests
  script:
    # Exit with an error if any of the lint cache files do not exist.
    - if [ ! -f core/phpstan-tmp/resultCache.php ]; then exit 1; fi
    - if [ ! -f core/.cspellcache ]; then exit 1; fi
    - if [ ! -f core/.eslintcache ]; then exit 1; fi
    - if [ ! -f core/.stylelintcache ]; then exit 1; fi
    - if [ ! -f core/.phpcscache ]; then exit 1; fi
