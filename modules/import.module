<?php

function import_help() {
 ?>
  <p>In Drupal you have <i>feeds</i> and <i>bundles</i>.   Feeds define news sources and bundles categoriz syndicated content by source, topic or any other heuristic.   Bundles provide a generalized way of creating composite feeds.  They allow you, for example, to combine various sport-related feeds into one bundle called "Sport".</p>
  <p>You can have several providers of news feeds.  You can add a feed by clicking the "add feed" link on the import administration pages.  Give the feed a name, supply the URI and a comma-separated list of attributes that you want to associate the feed with.  The update interval defines how often Drupal should go out to try and grab fresh content.  The expiration time defines how long syndicated content is kept in the database.  So set the update and expiration time and save your settings.  You have just defined your first feed.  If you have more feeds repeat as necessary.</p>
  <p>To verify whether your feed works, press "update items" at the overview page.  The number of news items that have been sucessfully fetched, should then become visible in the third column of the feed overview.</p>
  <p>Now you have to define some bundles.  Bundles look for feeds that contain one of the keywords associated with the bundle and display those feeds together.  To define a bundle you have to give it a name and a comma-separated list of keywords just like this is the case for feeds.</p>
  <p>Your newly created bundle will now show up in the list of blocks that you can see at the block related administration pages.  There you can customize where and when your bundles will be displayed.</p>
 <?php
}

function import_system($field){
  $system["description"] = t("Used to aggregate syndicated content (RSS and RDF).");
  return $system[$field];
}

function import_conf_options() {
  $number = array(5 => 5, 10 => 10, 15 => 15, 20 => 20, 25 => 25, 30 => 30, 35 => 35, 40 => 40, 45 => 45, 50 => 50, 55 => 55, 60 => 60, 65 => 65, 70 => 70, 75 => 75, 80 => 80, 85 => 85, 90 => 90, 95 => 95, 100 => 100);
  $output .= form_select("Items per block", "import_block_limit", variable_get("import_block_limit", 15), $number, "The maximum number of news items displayed in one block.");
  $output .= form_select("Items per page", "import_page_limit", variable_get("import_page_limit", 75), $number, "The maximum number of news items displayed on one page.");

  return $output;
}

function import_perm() {
  return array("administer news feeds", "access news feeds");
}

function import_link($type) {
  if ($type == "admin" && user_access("administer news feeds")) {
    $links[] = la(t("news feeds"), array("mod" => "import"));
  }

  if ($type == "page" && user_access("access news feeds")) {
    $links[] = lm(t("news feeds"), array("mod" => "import"), "", array("title" => t("Read the latest news from syndicated websites.")));
  }

  return $links ? $links : array();
}

function import_cron() {
  $result = db_query("SELECT * FROM feed WHERE timestamp + refresh < ". time());
  while ($feed = db_fetch_array($result)) {
    import_refresh($feed);
  }
}

function import_update() {
  $result = db_query("SELECT * FROM feed");
  while ($feed = db_fetch_array($result)) {
    import_refresh($feed);
  }
}

function import_format_item($item, $feed = 0) {
  global $theme, $user;

  if ($user->uid && user_access("post content")) {
    $output .= lm("<img src=\"". $theme->image("blog.gif") ."\" border=\"0\" width=\"12\" height=\"16\" alt=\"". t("Blog this item") ."\" />", array("mod" => "node", "op" => "add", "type" => "blog", "iid" => $item->iid), "", array("title" => t("Comment on this news item in your personal blog.")));
  }

  // external link
  $output .= "<a href=\"". check_output($item->link) ."\" target=\"new\">". check_output($item->title) ."</a>";

  return $output ."<br />";
}

function import_bundle_block($attributes) {

  if ($attributes) {
    $keys = explode(",", $attributes);
    foreach ($keys as $key) $where[] = "attributes LIKE '%". trim($key) ."%'";

    $result = db_query("SELECT * FROM item WHERE ". implode(" OR ", $where) ." ORDER BY iid DESC LIMIT ". variable_get("import_block_limit", 15));
  }

  while ($item = db_fetch_object($result)) {
    $output .= import_format_item($item);
  }

  return $output;
}

function import_feed_block($feed) {
  $result = db_query("SELECT * FROM item WHERE fid = '%s' ORDER BY iid DESC LIMIT ". variable_get("import_block_limit", 15), $feed->fid);

  while ($item = db_fetch_object($result)) {
    $output .= import_format_item($item);
  }

  return $output;
}

function import_block($op, $delta) {
  if ($op == "list") {
    $result = db_query("SELECT * FROM bundle ORDER BY title");
    while ($bundle = db_fetch_object($result)) {
      $block[$bundle->bid]["info"] = "$bundle->title bundle";
    }

    $result = db_query("SELECT * FROM feed ORDER BY fid");
    while ($feed = db_fetch_object($result)) {
      $block[$feed->fid]["info"] = "$feed->title feed";
    }

    return $block;
  }
  else {
    $feed = db_fetch_object(db_query("SELECT * FROM feed WHERE fid = '%d'", $delta));
    if ($feed) {
      $block["subject"] = $feed->title;
      $block["content"] = import_feed_block($feed) ."<p style=\"text-align: right\">". lm(t("more"), array("mod" => "import", "op" => "feed", "id" => $feed->fid), "", array("title" => t("View this feed's recent news."))) ."</p>";
    }
    else {
      // it was a bundle. this is NOT elegant
      $bundle = db_fetch_object(db_query("SELECT * FROM bundle WHERE bid = '%d'", $delta));
      $block["subject"] = $bundle->title;
      $block["content"] = import_bundle_block($bundle->attributes) ."<p style=\"text-align: right\">". lm(t("more"), array("mod" => "import", "op" => "bundle", "id" => $bundle->bid), "", array("title" => t("View this bundle's recent news."))) ."</p>";
    }

    return $block;
  }
}

function import_get_bundles($attributes = 0) {

  $block = array();

  $result = db_query("SELECT * FROM bundle ORDER BY title");
  while ($bundle = db_fetch_object($result)) {
    $block[$bundle->bid]["subject"] = $bundle->title;
    $block[$bundle->bid]["content"] = import_bundle_block($bundle->attributes) ."<p style=\"text-align: right\">". lm(t("more"), array("mod" => "import", "op" => "bundle", "id" => $bundle->bid), "", array("title" => t("View this bundle's recent news."))) ."</p>";
    $block[$bundle->bid]["info"] = "$bundle->title bundle";
  }

  return $block;
}

function import_get_feeds($attributes = 0) {

  $block = array();

  $result = db_query("SELECT * FROM feed ORDER BY fid");
  while ($feed = db_fetch_object($result)) {
    $block[$feed->fid]["subject"] = $feed->title;
    $block[$feed->fid]["content"] = import_feed_block($feed) ."<p style=\"text-align: right\">". lm(t("more"), array("mod" => "import", "op" => "feed", "id" => $feed->fid), "", array("title" => t("View this feed's recent news."))) ."</p>";
    $block[$feed->fid]["info"] = "$feed->title feed";
  }

  return $block;
}

function import_remove($feed) {
  db_query("DELETE FROM item WHERE fid = '%s'", $feed["fid"]);
  return t("removed news items from '%site'.", array("%site" => $feed["title"]));
}

// Call-back function used by XML parser:
function import_element_start($parser, $name, $attributes) {
  global $item, $element, $tag;

  switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
      $element = $name;
      break;
    case "ITEM":
      $element = $name;
      $item += 1;
  }

  $tag = $name;
}

// Call-back function used by XML parser:
function import_element_end($parser, $name) {
  global $element;

   switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
    case "ITEM":
      $element = "";
  }
}

// Call-back function used by XML parser:
function import_element_data($parser, $data) {
  global $channel, $element, $items, $item, $tag;

  switch ($element) {
    case "ITEM":
      $items[$item][$tag] .= $data;
      break;
    case "IMAGE":
    case "TEXTINPUT":
      /*
      ** The sub-elements "image" and "textinput" are not supported
      ** but we have recognize them or their content will end up in
      ** the items-array.
      */
      break;
    default:
      $channel[$tag] .= $data;
  }
}

function import_refresh($feed) {
  // unset the global variables before we use them:
  unset($GLOBALS["channel"], $GLOBALS["element"], $GLOBALS["item"], $GLOBALS["items"], $GLOBALS["tag"]);

  // after we unset the variables, we can global them again:
  global $items, $channel;

  /*
  ** Check whether the feed is properly configured:
  */

  if (!ereg("^http://|ftp://", $feed["url"])) {
    return t("failed to parse RSS feed '%site': incorrect or missing URL.", array("%side" => $feed["title"]));
  }

  /*
  ** Grab the news items:
  */

  if ($fp = @fopen($feed["url"], "r")) {
    // fetch data:
    while (!feof($fp)) {
      $data .= fgets($fp, 128);
    }
    fclose($fp);

    // parse the data:
    $xml_parser = xml_parser_create();
    xml_set_element_handler($xml_parser, "import_element_start", "import_element_end");
    xml_set_character_data_handler($xml_parser, "import_element_data");
    if (!xml_parse($xml_parser, $data, 1)) {
      return t("failed to parse RSS feed '%site': %error at line %line.", array("%site" => $feed["title"], "%error" => xml_error_string(xml_get_error_code($xml_parser)), "%line" => xml_get_current_line_number($xml_parser)));
    }
    xml_parser_free($xml_parser);

    // initialize the translation table:
    $tt = array_flip(get_html_translation_table(HTML_ENTITIES));
    $tt["&apos;"] = "'";

    /*
    ** Strip invalid tags and provide default values (if required):
    */

    $feed["link"] = strip_tags($channel["LINK"]);
    $feed["description"] = filter(strtr($channel["DESCRIPTION"], $tt));

    db_query("UPDATE feed SET timestamp = '%d', link = '%s', description = '%s' WHERE fid = '%d'", time(), $feed["link"], $feed["description"], $feed["fid"]);

    /*
    ** We reverse the array such that we store the first item last,
    ** and the last item first.  In the database, the newest item
    ** should be at the top.
    */

    $items = array_reverse($items);

    foreach ($items as $item) {
      unset($title, $link, $author, $description);

      // Prepare the description:
      $description = filter(strtr($item["DESCRIPTION"], $tt));

      // Prepare the title:
      if ($item["TITLE"]) {
        $title = strip_tags(strtr($item["TITLE"], $tt));
      }
      else {
        /*
         ** Use up to 40 characters of the $description, ending at
         ** word boundary, but don't split potential entities.
         */
        $title = preg_replace('/^(.*)[^\w;&].*?$/', "\\1", substr(strip_tags($description), 0, 40));
      }
      if ($item["LINK"]) {
        $link = strip_tags($item["LINK"]);
      }
      elseif ($item["GUID"] && (strncmp($item["GUID"], "http://", 7) == 0)) {
        $link = strip_tags($item["GUID"]);
      }
      else {
        $link = $feed["link"];
      }

      $author = strip_tags($item["AUTHOR"]);

      // print "<pre>title = ". htmlentities($title) ."\n\ndescription = ". htmlentities($description) ."\n\nlink = ". htmlentities($link) ."</pre><hr />";

      /*
       ** Save this item.  Try to avoid duplicate entries as much as
       ** possible.  If we find a duplicate entry, we resolve it and
       ** pass along its ID such that we can update it (when needed).
       */

      if ($link && $link != $feed["link"] && $link != $feed["url"]) {
        $entry = db_fetch_object(db_query("SELECT iid FROM item WHERE fid = '%s' AND link = '%s'", $feed["fid"], $link));
      }
      else {
        $entry = db_fetch_object(db_query("SELECT iid FROM item WHERE fid = '%s' AND title = '%s'", $feed["fid"], $title));
      }

      import_save_item(array(iid => $entry->iid, fid => $feed["fid"], title => $title, link => $link, author => $author, description => $description, attributes => $feed["attributes"]));
    }

    /*
    ** Remove all the old, expired items:
    */

    unset($items);

    $result = db_query("SELECT iid FROM item WHERE fid = '%s' ORDER BY timestamp", $feed["fid"]);

    while ($item = db_fetch_object($result)) {
      $items[] = "iid = '$item->iid'";
    }

    if (sizeof($items) > 50) {
      db_query("DELETE FROM item WHERE ". implode(" OR ", array_slice($items, 0, - 50)));
    }

  }
  else {
    return t("failed to parse RSS feed '%site': no data.", array("%site" => $feed["tite"]));
  }

  return t("syndicated content from '%site'.", array("%site" => $feed["title"]));
}

function import_save_item($edit) {
  if ($edit["iid"] && $edit["title"]) {
    db_query("UPDATE item SET title = '%s', link = '%s', author = '%s', description = '%s', attributes = '%s' WHERE iid = '%s'", $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], $edit["iid"]);
  }
  else if ($edit["iid"]) {
    db_query("DELETE FROM item WHERE iid = '%s'", $edit["iid"]);
  }
  else if ($edit["title"] && $edit["link"]) {
    db_query("INSERT INTO item (fid, title, link, author, description, attributes, timestamp) VALUES ('%s', '%s', '%s', '%s', '%s', '%s', '%s')", $edit["fid"], $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], time());
  }
}

function import_form_bundle($edit = array()) {

  $form .= form_textfield("Title", "title", $edit["title"], 50, 64, "The name of the bundle.");
  $form .= form_textfield("Attributes", "attributes", $edit["attributes"], 50, 128, "A comma-separated list of keywords describing the bundle.");

  $form .= form_submit("Submit");

  if ($edit["bid"]) {
    $form .= form_submit("Delete");
    $form .= form_hidden("bid", $edit["bid"]);
  }

  return form($form);
}

function import_save_bundle($edit) {
  if ($edit["bid"] && $edit["title"]) {
    db_query("UPDATE bundle SET title = '%s', attributes = '%s' WHERE bid = '%s'", $edit["title"], $edit["attributes"], $edit["bid"]);
  }
  else if ($edit["bid"]) {
    db_query("DELETE FROM bundle WHERE bid = '%s'", $edit["bid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("import");
    db_query("INSERT INTO bundle (bid, title, attributes) VALUES ('%d', '%s', '%s')", $next_id, $edit["title"], $edit["attributes"]);
  }
}

function import_form_feed($edit = array()) {

  $period = array(900 => format_interval(900), 1800 => format_interval(1800), 3600 => format_interval(3600), 7200 => format_interval(7200), 10800 => format_interval(10800), 21600 => format_interval(21600), 32400 => format_interval(32400), 43200 => format_interval(43200), 64800 => format_interval(64800), 86400 => format_interval(86400), 172800 => format_interval(172800), 259200 => format_interval(259200), 604800 => format_interval(604800), 1209600 => format_interval(1209600), 2419200 => format_interval(2419200));

  if ($edit["refresh"] == "") {
    $edit["refresh"] = 3600;
  }

  $form .= form_textfield("Title", "title", $edit["title"], 50, 64, "The name of the feed; typically the name of the website you syndicate content from.");
  $form .= form_textfield("Url", "url", $edit["url"], 50, 128, "The fully-qualified URL of the feed.");
  $form .= form_textfield("Attributes", "attributes", $edit["attributes"], 50, 128, "A comma-separated list of keywords describing the feed.");
  $form .= form_select("Update interval", "refresh", $edit["refresh"], $period, "The refresh interval indicating how often you want to update this feed.  Requires crontab.");

  $form .= form_submit("Submit");

  if ($edit["fid"]) {
    $form .= form_submit("Delete");
    $form .= form_hidden("fid", $edit["fid"]);
  }

  return form($form);
}

function import_save_feed($edit) {
  if ($edit["fid"] && $edit["title"]) {
    db_query("UPDATE feed SET title = '%s', url = '%s', attributes = '%s', refresh = '%s' WHERE fid = '%s'", $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"], $edit["fid"]);
    db_query("DELETE FROM item WHERE fid = '%s'", $edit["fid"]);
  }
  else if ($edit["fid"]) {
    db_query("DELETE FROM feed WHERE fid = '%s'", $edit["fid"]);
    db_query("DELETE FROM item WHERE fid = '%s'", $edit["fid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("import");
    db_query("INSERT INTO feed (fid, title, url, attributes, refresh) VALUES ('%d', '%s', '%s', '%s', '%s')", $next_id, $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"]);
  }
}

function import_save_attributes($edit) {
  foreach ($edit as $iid => $value) {
    db_query("UPDATE item SET attributes = '%s' WHERE iid = '%s'", $value, $iid);
  }
  return "attributes has been saved";
}

function import_get_feed($fid) {
  return db_fetch_array(db_query("SELECT * FROM feed WHERE fid = '%s'", $fid));
}

function import_get_bundle($bid) {
  return db_fetch_array(db_query("SELECT * FROM bundle WHERE bid = '%s'", $bid));
}

function import_view() {
  $result = db_query("SELECT f.*, COUNT(i.iid) AS items FROM feed f LEFT JOIN item i ON f.fid = i.fid GROUP BY f.fid, f.title, f.url, f.refresh, f.timestamp, f.attributes, f.link, f.description ORDER BY f.title");

  $output .= "<h3>Feed overview</h3>";
  $output .= "<table border=\"1\" cellpadding=\"2\" cellspacing=\"2\">\n";
  $output .= " <tr><th>title</th><th>attributes</th><th>items</th><th>last update</th><th>next update</th><th colspan=\"3\">operations</th></tr>\n";
  while ($feed = db_fetch_object($result)) {
    $output .= " <tr><td>". check_output($feed->title) ."</td><td>". check_output($feed->attributes) ."</td><td>". format_plural($feed->items, "item", "items") ."</td><td>". ($feed->timestamp ? format_interval(time() - $feed->timestamp) ." ago" : "never") ."</td><td>". ($feed->timestamp ? format_interval($feed->timestamp + $feed->refresh - time()) ." left" : "never") ."</td><td>". la(t("edit feed"), array("mod" => "import", "type" => "feed", "op" => "edit", "id" => $feed->fid)) ."</td><td>". la(t("remove items"), array("mod" => "import", "type" => "feed", "op" => "remove", "id" => $feed->fid)) ."</td><td>". la(t("update items"), array("mod" => "import", "type" => "feed", "op" => "update", "id" => $feed->fid)) ."</td></tr>\n";
  }
  $output .= "</table>\n";

  $result = db_query("SELECT * FROM bundle ORDER BY title");

  $output .= "<h3>Bundle overview</h3>";
  $output .= "<table border=\"1\" cellpadding=\"2\" cellspacing=\"2\">\n";
  $output .= " <tr><th>title</th><th>attributes</th><th>operations</th></tr>\n";
  while ($bundle = db_fetch_object($result)) {
    $output .= " <tr><td>". check_output($bundle->title) ."</td><td>". check_output($bundle->attributes) ."</td><td>". la(t("edit bundle"), array("mod" => "import", "type" => "bundle", "op" => "edit", "id" => $bundle->bid)) ."</td></tr>\n";
  }
  $output .= "</table>\n";

  return $output;
}

function import_fd_form() {

  $form .= form_textfield("Feed directory file", "url", "http://", 64, 128, "The fully-qualified URL of the feed directory file.");
  $form .= form_submit("Collect feeds");

  return form($form);
}

function import_fd_collect($edit) {

  set_time_limit(180);

  if ($fp = @fopen($edit["url"], "r")) {
    // fetch data:
    while (!feof($fp)) {
      $data .= fgets($fp, 128);
    }
    fclose($fp);

    // initialize the translation table:
    $tt = array_flip(get_html_translation_table(HTML_ENTITIES));
    $tt["&apos;"] = "'";

    $items = explode("</channel>", $data);

    foreach ($items as $item) {
      unset($link, $title);

      // print "<pre>item = ". htmlentities($item) ."\n\n</pre>";

      eregi("<link>(.*)</link>", $item, $link);
      eregi("<title>(.*)</title>", $item, $title);

      $link = strip_tags(strtr($link[1], $tt));
      $title = strip_tags(strtr($title[1], $tt));

      // print "<b>title = $title, link = $link<br /></b>";
      if ($link && $link && !db_fetch_array(db_query("SELECT * FROM feed WHERE url = '%s'", $link))) {
        $output .= "<input type=\"checkbox\" name=\"edit[$title]\" value=\"$link\"> ". strtr($title, $tt) ."<br />";
      }
    }

    $output .= "<input type=\"submit\" name=\"op\" value=\"Import feeds\" />\n";

    return form($output);
  }
  else {
    print status("failed to open '". $edit["url"] ."': $errstr.");
  }
}

function import_fd_import($edit) {
  if ($edit) {
    foreach ($edit as $title => $link) {
      import_save_feed(array("title" => $title, "url" => $link, "refresh" => 3600));
    }
  }
}

function import_tag() {

  $result = db_query("SELECT i.*, f.title AS feed FROM item i LEFT JOIN feed f ON i.fid = f.fid ORDER BY i.iid DESC LIMIT 50");

  $output .= "<table border=\"1\" cellpadding=\"2\" cellspacing=\"2\">\n";
  $output .= " <tr><th>time</th><th>feed</th><th>item</th></tr>\n";
  while ($item = db_fetch_object($result)) {
    $output .= " <tr><td valign=\"top\" nowrap=\"nowrap\">". format_date($item->timestamp, "custom", "m/d/y") ."<br />". format_date($item->timestamp, "custom", "H:i") ."</td><td align=\"center\" valign=\"top\" nowrap=\"nowrap\">". la(check_output($item->feed), array("mod" => "import", "type" => "feed", "op" => "edit", "id" => $item->fid)) ."</td><td><a href=\"". check_output($item->link) ."\">". check_output($item->title) ."</a>". ($item->description ? "<br /><small><i>". check_output($item->description, 1) ."</i></small>" : "") ."<br /><input type=\"text\" name=\"edit[$item->iid]\" value=\"". check_form($item->attributes) ."\" size=\"50\" /></td></tr>\n";
  }
  $output .= "</table>\n";
  $output .= "<input type=\"submit\" name=\"op\" value=\"Save attributes\" />\n";

  return form($output);
}

function import_admin() {
  global $op, $id, $type, $edit;

  if (user_access("administer news feeds")) {

    $links[] = la(t("add new feed"), array("mod" => "import", "type" => "feed", "op" => "add"));
    $links[] = la(t("add new bundle"), array("mod" => "import", "type" => "bundle", "op" => "add"));
    $links[] = la(t("import feeds"), array("mod" => "import", "op" => "fd"));
    $links[] = la(t("tag items"), array("mod" => "import", "op" => "tag"));
    $links[] = la(t("overview"), array("mod" => "import", "op" => "view"));
    $links[] = la(t("help"), array("mod" => "import", "op" => "help"));

    print "<small>". implode(" | ", $links) ."</small><hr />";

    switch ($op) {
      case "help":
        print import_help();
        break;
      case "add":
        if ($type == "bundle") {
          print import_form_bundle();
        }
        else {
          print import_form_feed();
        }
        break;
      case "edit":
        if ($type == "bundle") {
          print import_form_bundle(import_get_bundle($id));
        }
        else {
          print import_form_feed(import_get_feed($id));
        }
        break;
      case "fd":
        print import_fd_form();
        break;
      case "Collect feeds":
        print import_fd_collect($edit);
        break;
      case "Import feeds":
        print import_fd_import($edit);
        print import_view();
        break;
      case "remove":
        print status(import_remove(import_get_feed($id)));
        print import_view();
        break;
      case "update":
        print status(import_refresh(import_get_feed($id)));
        print import_view();
        break;
      case "tag":
        print import_tag();
        break;
      case "Save attributes":
        print status(import_save_attributes($edit));
        print import_tag();
        break;
      case "Delete":
        $edit["title"] = 0;
        // fall through:
      case "Submit":
        if ($type == "bundle") {
          print status(import_save_bundle($edit));
        }
        else {
          print status(import_save_feed($edit));
        }
        // fall through:
      default:
        print import_view();
    }
  }
  else {
    print message_access();
  }
}

function import_page_info() {
  global $theme;

  $links[] = lm(t("latest news"), array("mod" => "import"), "", array("title" => t("Read the latest news from syndicated websites.")));
  $links[] = lm(t("news by source"), array("mod" => "import", "op" => "feeds"), "", array("title" => t("View the latest headlines sorted by source.")));
  $links[] = lm(t("news by topic"), array("mod" => "import", "op" => "bundles"), "", array("title" => t("View the latest headlines sorted by topic.")));
  $links[] = lm(t("news sources"), array("mod" => "import", "op" => "sources"), "", array("title" => t("View a list of all the websites we syndicate from.")));
  if (user_access("administer news feeds")) {
    $links[] = la(t("administer news feeds"), array("mod" => "import"), "", array("title" => t("View the news feed administrative pages.")));
  }

  return "<div style=\"text-align: center\">". $theme->links($links) ."</div>";
}

function import_page_last() {
  global $theme;

  $result = db_query("SELECT i.*, f.title AS ftitle, f.link AS flink FROM item i LEFT JOIN feed f ON i.fid = f.fid ORDER BY i.iid DESC LIMIT ". variable_get("import_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("post content")) {
      $links[] = lm(t("blog it"), array("mod" => "node", "op" => "add", "type" => "blog", "iid" => $item->iid), "", array("title" => t("Comment on this news item in your personal blog.")));
    }
    $links[] = lm(t("feed"), array("mod" => "import", "op" => "feed", "id" => $item->fid), "", array("title" => t("Read more syndicated news from this feed.")));

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". lm($item->ftitle, array("mod" => "import", "op" => "feed", "id" => $item->fid), "", array("title" => t("View more information about this feed."))) ."</td><td align=\"right\" nowrap=\"nowrap\" valign=\"top\">". $theme->links($links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">". check_output($item->description, 1) ."</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  $theme->header();
  $theme->box(t("News feeds"), import_page_info());
  $theme->box(t("Latest news"), $output);
  $theme->footer();
}

function import_page_feed($fid) {
  global $theme;

  $feed = db_fetch_object(db_query("SELECT * FROM feed WHERE fid = '%s'", $fid));

  $header .= "<p><b>". t("Website") .":</b><div style=\"margin-left: 20px;\"><a href=\"$feed->link\">$feed->link</a></div></p>";
  $header .= "<p><b>". t("Description") .":</b><div style=\"margin-left: 20px;\">". check_output($feed->description, 1) ."</div></p>";
  $header .= "<p><b>". t("Last update") .":</b><div style=\"margin-left: 20px;\">". format_interval(time() - $feed->timestamp) ." ". t("ago") ."<a href=\"$feed->url\"><img src=\"". $theme->image("xml.gif") ."\" width=\"36\" height=\"14\" align=\"right\" border=\"0\" /></a><br /><br /></div></p>\n";

  $result = db_query("SELECT * FROM item WHERE fid = '%s' ORDER BY iid DESC LIMIT ". variable_get("import_page_limit", 75), $fid);

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("post content")) {
      $links[] = lm(t("blog it"), array("mod" => "node", "op" => "add", "type" => "blog", "iid" => $item->iid), "", array("title" => t("Comment on this news item in your personal blog.")));
    }
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a></td><td align=\"right\" nowrap=\"nowrap\" valign=\"top\">". $theme->links($links) ."</td></tr>\n";
    }
    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">". check_output($item->description, 1) ."</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  $theme->header();
  $theme->box(t("News feeds"), import_page_info());
  $theme->box(check_output($feed->title), $header);
  $theme->box(t("Latest news"), $output);
  $theme->footer();
}

function import_page_bundle($bid) {
  global $theme;

  $bundle = db_fetch_object(db_query("SELECT * FROM bundle WHERE bid = '%s'", $bid));

  $header .= "<p><b>". t("Website") .":</b><div style=\"margin-left: 20px;\">". lm($bundle->title, array("mod" => "import", "op" => "bundle", "id" => $bundle->bid)) ."</div></p>";
  $header .= "<p><b>". t("Description") .":</b><div style=\"margin-left: 20px;\">". t("A composite news feed about") ." ". check_output($bundle->attributes) .".</div></p>";

  $keys = explode(",", $bundle->attributes);
  foreach ($keys as $key) $where[] = "i.attributes LIKE '%". trim($key) ."%'";
  $result = db_query("SELECT i.*, f.title AS ftitle, f.link AS flink FROM item i, feed f WHERE (". implode(" OR ", $where) .") AND i.fid = f.fid ORDER BY iid DESC LIMIT ". variable_get("import_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("post content")) {
      $links[] = lm(t("blog it"), array("mod" => "node", "op" => "add", "type" => "blog", "iid" => $item->iid), "", array("title" => t("Comment on this news item in your personal blog.")));
    }
    $links[] = lm(t("feed"), array("mod" => "import", "op" => "feed", "id" => $item->fid), "", array("title" => t("Read more syndicated news from this feed.")));
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". lm($item->ftitle, array("mod" => "import", "op" => "feed", "id" => $item->fid), "", array("title" => t("View more information about this feed."))) ."</td><td align=\"right\" nowrap=\"nowrap\" valign=\"top\">". $theme->links($links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">". check_output($item->description, 1) ."</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  $theme->header();
  $theme->box(t("News feeds"), import_page_info());
  $theme->box(check_output($bundle->title), $header);
  $theme->box(t("Latest news"), $output);
  $theme->footer();

}

function import_page_sources() {
  global $theme;

  $result = db_query("SELECT * FROM feed ORDER BY title");

  while ($feed = db_fetch_object($result)) {
    $output .= lm($feed->title, array("mod" => "import", "op" => "feed", "id" => $feed->fid));
    $output .= "<div style=\"margin-left: 20px;\">". check_output($feed->description, 1) ."</div><br />";
  }

  $output .= lm("<img src=\"". $theme->image("xml.gif") ."\" width=\"36\" height=\"14\" align=\"right\" border=\"0\" />", array("mod" => "import", "op" => "fd"), "", array("title" => t("View the list of syndicated websites in XML format."))) ."<br />\n";

  $theme->header();
  $theme->box(t("News feeds"), import_page_info());
  $theme->box(t("News sources"), $output);
  $theme->footer();
}

function import_page_fd() {

  $result = db_query("SELECT * FROM feed ORDER BY title");

  $output .= "<?xml version=\"1.0\"?>\n\n";
  $output .= "<rssfeeds version=\"0.1\">\n\n";

  while ($feed = db_fetch_object($result)) {
    $output .= "<channel>\n";
    $output .= " <title>". htmlentities($feed->title) ."</title>\n";
    $output .= " <link>". htmlentities($feed->url) ."</link>\n";
    $output .= "</channel>\n\n";
  }

  $output .= "</rssfeeds>\n";

  header("Content-Type: text/xml");

  print $output;
}

function import_page_bundles() {
  import_page_blocks(import_get_bundles());
}

function import_page_feeds() {
  import_page_blocks(import_get_feeds());
}

function import_page_blocks($blocks) {
  global $theme;

  $theme->header();
  $theme->box(t("News feeds"), import_page_info());
  print "<table cellpadding=\"0\" cellspacing=\"5\" border=\"0\" width=\"100%\">\n";
  print " <tr>\n";

  for ($t = 0; $t < 3; $t++) {
    $i = 1;
    print "  <td width=\"33%\" valign=\"top\">\n";
    while ($block = each($blocks)) {
      $theme->box($block["value"]["subject"], $block["value"]["content"]);
      if ($i == ceil(count($blocks) / 3)) {
        break;
      }
      $i++;
    }
    print "  </td>\n";
  }

  print " </tr>\n";
  print "</table>\n";
  $theme->footer();
}

function import_page() {
  global $op, $id;

  if (user_access("access news feeds")) {
    switch ($op) {
      case "feed":
        import_page_feed($id);
        break;
      case "bundle":
        import_page_bundle($id);
        break;
      case "feeds":
        import_page_feeds();
        break;
      case "bundles":
        import_page_bundles();
        break;
      case "sources":
        import_page_sources();
        break;
      case "fd":
        import_page_fd();
        break;
      default:
        import_page_last();
    }
  }
}

?>
