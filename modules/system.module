<?php

function system_help() {
  $output .= "<p>Drupal comes with system-wide defaults but the setting-module provides control over many Drupal preferences, behaviors including visual and operational settings.</p>";
  $output .= "<h3>Cache</h3>". system_help_cache();
  $output .= "<h3>Cron</h3>". system_help_cron();
  return $output;
}

function system_system($field){
  $system["description"] = t("Configuration system that lets site admins modify the workings of the site.");
  return $system[$field];
}

function system_help_cache() {
  $output .= "<p>Drupal has a caching mechanism that stores dynamically generated pages in a database.  By caching a page, Drupal does not have to generate the page each time it is requested.  Only pages requested by anonymous users are being cached.  When a cached page is accessed, Drupal will retrieve that page with minimal overhead using one SQL query only, thus reducing both the server load and the response time.</p>";
  $output .= "<p>Drupal's caching mechanism can be enabled and disabled by the site administrators from the 'settings' page.  Site administrators can also define how long cached pages should be kept.</p>";
  return $output;
}

function system_help_cron() {
  $output .= "<p>Some settings require a <i>cron</i> or <i>crontab</i>.  Cron, which stands for chronograph, is a periodic command scheduler: it executes commands at intervals specified in seconds.  It can be used to control the execution of daily, weekly and monthly jobs (or anything with a period of <i>n</i> seconds).   Automating tasks is one of the best ways to keep a system running smoothly, and if most of your administration does not require your direct involvement, cron is an ideal solution.</p>";
  $output .= "<p>Whenever <a href=\"". path_uri() ."cron.php\">". path_uri() ."cron.php</a> is accessed, cron will run: it checks for the jobs cron controls, and their periods in seconds.  If a certain task wasn't executed in the last n seconds, where n is the period of that job, it will be executed.  When all the executed commands terminate, cron is done.</p>";
  $output .= "<p>The recommended way to setup your cron system is to setup a Unix/Linux crontab that frequently visits <a href=\"". path_uri() ."cron.php\">". path_uri() ."cron.php</a>.  Note that cron does not guarantee the commands will be executed at the specified interval.  However, Drupal will try his best and run the crons as close to the specified intervals as possible.  The more you visit cron.php, the more accurate cron will be.</p>";
  $output .= "<p>If your hosting company does not allow you to setup crontabs, you can always ask someone else to setup a crontab for you. After all, virtually any Unix/Linux machine with access to the internet can setup a crontab to frequently visit <a href=\"". path_uri() ."cron.php\">". path_uri() ."cron.php</a>.</p>";
  $output .= "<p>For the Unix/Linux crontab itself, use a browser like <i>lynx</i> or <i>wget</i> but make sure the process terminates: either use <code>/usr/bin/lynx -source <?php echo path_uri(); ?>cron.php</code> or <code>/usr/bin/wget -O /dev/null <?php echo path_uri(); ?>cron.php</code>.  Take a look at the example scripts in the <code>scripts</code>-directory and make sure to adjust them to your needs.  A good crontab-line to run the cron-script once every hour would be: <pre>     00 * * * * /home/www/drupal/scripts/cron-lynx</pre></p>";
  return $output;
}

function system_perm() {
  return array("administer site configuration", "access administration pages", "create php content");
}

function system_link($type) {
  if ($type == "admin" && user_access("administer site configuration")) {
    $links[] = la(t("site configuration"), array("mod" => "system"));
  }

  return $links ? $links : array();
}

function system_view_options() {
  global $conf, $cmodes, $corder;

  // general settings:
  $output .= "<h3>" . t("General settings") . "</h3>\n";
  $output .= form_textfield(t("Name"), "site_name", variable_get("site_name", "drupal"), 55, 55, t("The name of this website."));
  $output .= form_textfield(t("E-mail address"), "site_mail", variable_get("site_mail", ini_get("sendmail_from")), 55, 128, t("A valid e-mail address for this website, used by the auto-mailer during registration, new password requests, notifications, etc."));
  $output .= form_textfield(t("Slogan"), "site_slogan", variable_get("site_slogan", ""), 55, 128, t("The slogan of this website. Some themes display a slogan when available."));
  $output .= form_textarea(t("Mission"), "site_mission", variable_get("site_mission", ""), 55, 5, t("Your site's mission statement or focus."));
  $output .= form_textarea(t("Footer message"), "site_footer", variable_get("site_footer", ""), 55, 5, t("This text will be displayed at the bottom of each page.  Useful for adding a copyright notice to your pages."));
  $output .= form_textfield(t("Anonymous user"), "anonymous", variable_get("anonymous", "Anonymous"), 55, 55, t("The name used to indicate anonymous users."));
  foreach (module_list() as $name) { if (module_hook($name, "page")) $pages[$name] = $name; }
  $output .= form_select(t("Default front page"), "site_frontpage", variable_get("site_frontpage", "node"), $pages, t("The home page displays content from this module (usually node)."));
  $output .= "<hr />\n";

  // caching:
  $output .= "<h3>" . t("Cache settings") . "</h3>\n";
  $period = array(10 => format_interval(10), 20 => format_interval(20), 30 => format_interval(30), 40 => format_interval(40), 50 => format_interval(50), 50 => format_interval(50), 60 => format_interval(60), 90 => format_interval(90), 120 => format_interval(120), 150 => format_interval(150), 180 => format_interval(180), 210 => format_interval(210), 240 => format_interval(240), 270 => format_interval(270), 300 => format_interval(300), 360 => format_interval(360), 420 => format_interval(420), 480 => format_interval(480), 540 => format_interval(540), 600 => format_interval(600), 1800 => format_interval(1800), 3600 => format_interval(3600), 7200 => format_interval(7200));
  $output .= form_select(t("Cache support"), "cache", variable_get("cache", 0), array(t("Disabled"), t("Enabled")), t("Enable or disable the caching of pages."));
  $output .= form_select(t("Discard cached pages older than"), "cache_clear", variable_get("cache_clear", 120), $period, t("The time cached pages should be kept.  Older pages are automatically refreshed."));
  $output .= "<hr />\n";

  // submission settings:
  $output .= "<h3>" . t("Submission settings") . "</h3>\n";
  $rate = array(-10000 => "Disabled", 1 => "Maximum 1 every second", 5 => "Maximum 1 every 5 seconds", 15 => "Maximum 1 every 15 seconds", 30 => "Maximum 1 every 30 seconds", 60 => "Maximum 1 every minute", 300 => "Maximum 1 every 5 minutes", 900 => "Maximum 1 every 15 minutes", 1800 => "Maximum 1 every 30 minutes", 3600 => "Maximum 1 every hour", 21600 => "Maximum 1 every 6 hours", 43200 => "Maximum 1 every 12 hours");
  $output .= form_select(t("Maximum node rate"), "max_node_rate", variable_get("max_node_rate", 900), $rate, t("The maximum submission rate for nodes.  Its purpose is to stop potential abuse or denial of service attacks."));
  $output .= form_select(t("Maximum comment rate"), "max_comment_rate", variable_get("max_comment_rate", 120), $rate, t("The maximum submission rate for comments.  Its purpose is to stop potential abuse or denial of service attacks."));
  $output .= "<hr />\n";

  // date settings:
  $output .= "<h3>" . t("Date format setting") . "</h3>\n";
  $output .= form_select(t("Date format"), "date_format", variable_get("date_format", "m/d/Y - H:i"), array("m/d/Y - H:i" => "m/d/Y - H:i", "d/m/Y - H:i" => "d/m/Y - H:i", "Y/m/d - H:i" => "Y/m/d - H:i"), t("The format in which dates are displayed"));
  $output .= "<hr />\n";

  // layout settings:
  $output .= "<h3>" . t("Layout settings") . "</h3>\n";
  foreach (theme_list() as $key => $value) $options .= "<option value=\"$key\"". (variable_get("theme_default", 0) == $key ? " selected=\"selected\"" : "") .">$key</option>\n";
  $output .= form_item(t("Default theme"), "<select name=\"edit[theme_default]\">$options</select>", t("The default theme as seen by visitors or anonymous users."));
  $output .= "<hr />\n";

  // development settings:
  $output .= "<h3>" . t("Development settings") . "</h3>\n";
  $output .= form_select(t("Display timer information"), "dev_timer", variable_get("dev_timer", 0), array(t("Disabled"), t("Enabled")), t("Display the time it took to generate a page.  For Drupal development only."));
  $output .= form_select(t("Display query log"), "dev_query", variable_get("dev_query", 0), array(t("Disabled"), t("Enabled")), t("Display a log of the database queries needed to generate the current page."));

  $output .= "<hr />\n";

  foreach (module_list() as $name) {
    if (module_hook($name, "conf_options")) {
      $output .= "<h3><a name=\"$name\">". ucfirst(t("$name")) ." " . t("settings") . "</a></h3>". module_invoke($name, "conf_options") ."<hr />\n";
    }
  }
  return $output;
}

function system_view_filters() {
  foreach (module_list() as $name) {
    if (module_hook($name, "conf_filters")) {
      $output .= module_invoke($name, "conf_filters");
    }
  }
  return $output;
}

function system_save($edit = array()) {
  foreach ($edit as $name => $value) {
    variable_set($name, $value);
  }

  return t("The configuration options have been saved.");
}

function system_default($edit = array()) {
  foreach ($edit as $name => $value) {
    variable_del($name);
  }

  return t("The configuration options have been reset to their default values.");
}

function system_view($type) {

  switch ($type) {
    case "filter":
      $output = "";
      $form = system_view_filters();
      break;
    default:
      foreach (module_list() as $name) {
        if (module_hook($name, "conf_options")) {
          $links[] = la(t("$name"), array("mod" => "system"), $name);
        }
      }

      $output = "<small>". implode(" :: ", $links) ."</small><hr />";
      $form = system_view_options();
  }

  $form .= form_submit(t("Save configuration"));
  $form .= form_submit(t("Reset to defaults"));

  return $output . form($form);
}

function system_dirscan($dir, $mask, $nomask = array(".", "..", "CVS")) {
  $files = array();
  if (is_dir($dir) && $handle = opendir($dir)) {
    while ($file = readdir($handle)) {
      if (!in_array($file, $nomask)) {
        if (is_dir("$dir/$file")) {
          $files = array_merge($files, system_dirscan("$dir/$file", $mask, $nomask));
        }
        elseif (ereg($mask, $file)) {
          $name = basename($file);
          $files["$dir/$file"]->filename = "$dir/$file";
          $files["$dir/$file"]->name = substr($name, 0, strrpos($name, '.'));
        }
      }
    }
    closedir($handle);
  }
  return $files;
}

function system_listing($type, $directory, $required = array()) {
  // Make sure we set $type correctly
  $type = $type != 'theme' ? "module" : "theme";

  // Find files in the directory.
  $files = system_dirscan($directory, "\.$type$");

  // Extract current files from database.
  $result = db_query("SELECT filename, type, status FROM system WHERE type = '%s'", $type);
  while ($file = db_fetch_object($result)) {
    if (is_object($files[$file->filename])) {
      foreach ($file as $key => $value) {
        $files[$file->filename]->$key = $value;
      }
    }
  }

  ksort($files);

  $output = "<table border=\"1\" cellpadding=\"2\" cellspacing=\"2\">\n";
  $output .= "<tr><th>" . t("name") . "</th><th>" . t("description") . "</th><th>" . t("enabled") . "</th></tr>\n";

  foreach ($files as $filename => $file) {
    include_once($filename);
    if ($type == "module") {
      $info->name = module_invoke($file->name, "system", "name") ? module_invoke($file->name, "system", "name") : $file->name;
      $info->description = module_invoke($file->name, "system", "description");
    }
    elseif ($type == "theme") {
      $class = "Theme_$file->name";
      if (class_exists($class)) {
        $theme =& new $class;
        $info->name = $theme->system("name") ? $theme->system("name") : $file->name;
        $info->description = $theme->system("description");
      }
      else {
        unset($files[$filename]);
      }
    }

    // Update the contents of the system table:
    db_query("DELETE FROM system WHERE filename = '%s' AND type = '%s'", $filename, $type);
    db_query("INSERT INTO system (name, description, type, filename, status) VALUES ('%s', '%s', '%s', '%s', %d)", $info->name, $info->description, $type, $filename, $file->status);

    $output .= "<tr>";
    $output .= "<td>$info->name</td>";
    $output .= "<td>$info->description</td>";
    $output .= "<td align=\"center\">". (in_array($filename, $required) ? form_hidden("status][$filename", 1) . t("required") : form_checkbox("", "status][$filename", 1, $file->status)) ."</td>";
    $output .= "</tr>\n";
  }
  $output .= "</table><br />\n";
  $output .= form_submit(t("Save $type settings"));

  return form($output);
}

function system_admin() {
  global $edit, $op, $type;
  if (user_access("administer site configuration")) {

    print "<small>". la(t("site settings"), array("mod" => "system", "type" => "options")) ." - ". la(t("content filters"), array("mod" => "system", "type" => "filter")) ." - ". la(t("modules"), array("mod" => "system", "op" => "modules")) ." - ". la(t("themes"), array("mod" => "system", "op" => "themes")) ." - ". la(t("help"), array("mod" => "system", "op" => "help")) ."</small><hr />\n";

    switch ($op) {
      case "help":
        print system_help();
        break;
      case t("Save module settings"):
        db_query("UPDATE system SET status = '0' WHERE type = 'module'");
        foreach ($edit["status"] as $filename => $status) {
          db_query("UPDATE system SET status = %d WHERE filename = '$filename'", $status);
        }
        cache_clear_all();
        print status(t("Settings successfully updated."));
      case "modules":
        // Note: changing this also requires changing module_init() @ includes/module.inc.
        $required = array("modules/user.module", "modules/system.module", "modules/watchdog.module");
        print system_listing("module", "modules", $required);
        break;
      case t("Save theme settings"):
        db_query("UPDATE system SET status = '0' WHERE type = 'theme'");
        foreach ($edit["status"] as $filename => $status) {
          db_query("UPDATE system SET status = %d WHERE filename = '$filename'", $status);
        }
        cache_clear_all();
        print status(t("Settings successfully updated."));
      case "themes":
        print system_listing("theme", "themes");
        break;
      case t("Reset to defaults"):
        print status(system_default($edit));
        print system_view($type);
        cache_clear_all();
        break;
      case t("Save configuration"):
        print status(system_save($edit));
        print system_view($type);
        cache_clear_all();
        break;
      default:
        print system_view($type);
    }
  }
  else {
    print message_access();
  }
}

?>
