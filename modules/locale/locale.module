<?php
// $Id: locale.module,v 1.166 2007/04/15 15:36:10 dries Exp $

/**
 * @file
 * Enables administrators to manage the site interface languages.
 *
 * When enabled, the site interface can be displayed in different
 * languages. The setup of languages and translations is completely
 * web based. Gettext portable object files are supported.
 */

// ---------------------------------------------------------------------------------
// Hook implementations (needed on all page loads)

/**
 * Implementation of hook_help().
 */
function locale_help($section) {
  switch ($section) {
    case 'admin/help#locale':
      $output = '<p>'. t('The locale module allows you to present your Drupal site in a language other than the default English. You can use it to set up a multi-lingual website or replace given <em>built-in</em> text with text which has been customized for your site. Whenever the locale module encounters text which needs to be displayed, it tries to translate it into the currently selected language. If a translation is not available, then the string is remembered, so you can look up untranslated strings easily.') .'</p>';
      $output .= '<p>'. t('The locale module provides two options for providing translations. The first is the integrated web interface, via which you can search for untranslated strings, and specify their translations. An easier and less time-consuming method is to import existing translations for your language. These translations are available as <em>GNU gettext Portable Object files</em> (<em>.po</em> files for short). Translations for many languages are available for download from the translation page.') .'</p>';
      $output .= '<p>'. t("If an existing translation does not meet your needs, the <em>.po</em> files are easily edited with special editing tools. The locale module's import feature allows you to add strings from such files into your site's database. The export functionality enables you to share your translations with others, generating Portable Object files from your site strings.") .'</p>';
      $output .= '<p>'. t('For more information please read the configuration and customization handbook <a href="@locale">Locale page</a>.', array('@locale' => 'http://drupal.org/handbook/modules/locale/')) .'</p>';
      return $output;
    case 'admin/build/locale':
    case 'admin/build/locale/language':
    case 'admin/build/locale/language/overview':
      return t("<p>Drupal provides support for the translation of its interface text into different languages. This page provides an overview of the installed languages. You can add a language on the <a href=\"@add-language\">add language page</a>, or directly by <a href=\"@import\">importing a translation</a>. If multiple languages are enabled, registered users will be able to set their preferred language. The site default will be used for anonymous visitors and for users without their own settings.</p><p>Drupal interface translations may be added or extended by several courses: by <a href=\"@import\">importing</a> an existing translation, by <a href=\"@search\">translating everything</a> from scratch, or by a combination of these approaches.</p>", array("@search" => url("admin/build/locale/string/search"), "@import" => url("admin/build/locale/language/import"), "@add-language" => url("admin/build/locale/language/add")));
    case 'admin/build/locale/language/add':
      return '<p>'. t("You need to add all languages in which you would like to display the site interface. If you can't find the desired language in the quick-add dropdown, then you will need to provide the proper language code yourself. The language code may be used to negotiate with browsers and to present flags, etc., so it is important to pick a code that is standardised for the desired language. You can also add a language by <a href=\"@import\">importing a translation</a>.", array("@import" => url("admin/build/locale/language/import"))) .'</p>';
    case 'admin/build/locale/language/import':
      return '<p>'. t("This page allows you to import a translation provided in the gettext Portable Object (.po) format. The easiest way to get your site translated is to obtain an existing Drupal translation and to import it. You can find existing translations on the <a href=\"@url\">Drupal translation page</a>. Note that importing a translation file might take a while.", array('@url' => 'http://drupal.org/project/translations')) .'</p>';
    case 'admin/build/locale/language/export':
      return '<p>'. t("This page allows you to export Drupal strings. The first option is to export a translation so it can be shared. The second option generates a translation template, which contains all Drupal strings, but without their translations. You can use this template to start a new translation using various software packages designed for this task.") .'</p>';
    case 'admin/build/locale/string':
    case 'admin/build/locale/string/search':
      return '<p>'. t("It is often convenient to get the strings from your setup on the <a href=\"@export\">export page</a>, and use a desktop Gettext translation editor to edit the translations. On this page you can search in the translated and untranslated strings, and the default English texts provided by Drupal.", array("@export" => url("admin/build/locale/language/export"))) .'</p>';
    case 'admin/build/locale/language/configure':
      return '<p>'. t('The language used to display a web page is determined with a negotiation algorithm. You can choose how this algorithm should work. By default, there is no negotiation and the default language is used. You can use path prefixes (like "de" and "it" for German and Italian content) with different fallback options, so you can have web addresses like /de/contact and /it/contact. Alternatively you can use custom domains like de.example.com and it.example.com. Customize path prefixes and set domain names on the <a href="@languages">language editing pages</a>.', array('@languages' => url('admin/build/locale/language/overview'))) .'</p>';
  }
}

/**
 * Implementation of hook_menu().
 */
function locale_menu() {
  // Main admin menu item
  $items['admin/build/locale'] = array(
    'title' => t('Languages'),
    'description' => t('Configure languages and user interface translation.'),
    'page callback' => 'locale_admin_manage',
    'access arguments' => array('administer locales'),
  );

  // Top level tabs
  $items['admin/build/locale/language'] = array(
    'title' => t('Manage languages'),
    'weight' => -10,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/build/locale/string'] = array(
    'title' => t('Manage interface strings'),
    'page callback' => 'locale_string_search',
    'weight' => 10,
    'type' => MENU_LOCAL_TASK,
    'parent' => 'admin/build/locale',
  );

  // Manage languages subtabs
  $items['admin/build/locale/language/overview'] = array(
    'title' => t('List'),
    'weight' => 0,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/build/locale/language/add'] = array(
    'title' => t('Add language'),
    'page callback' => 'locale_admin_manage_add',
    'weight' => 5,
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/build/locale/language/configure'] = array(
    'title' => t('Configure'),
    'page callback' => 'locale_admin_manage_configure',
    'weight' => 10,
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/build/locale/language/edit/%'] = array(
    'title' => t('Edit language'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('locale_admin_manage_edit', 5),
    'type' => MENU_CALLBACK,
  );

  // Manage interface translations subtabs
  $items['admin/build/locale/string/search'] = array(
    'title' => t('Search'),
    'weight' => 0,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/build/locale/string/import'] = array(
    'title' => t('Import'),
    'page callback' => 'locale_admin_import',
    'weight' => 10,
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/build/locale/string/export'] = array(
    'title' => t('Export'),
    'page callback' => 'locale_admin_export',
    'weight' => 20,
    'type' => MENU_LOCAL_TASK,
  );

  // Language related callbacks
  $items['admin/build/locale/language/delete'] = array(
    'title' => t('Confirm'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('locale_admin_manage_delete_form'),
    'type' => MENU_CALLBACK,
  );
  // String related callbacks
  $items['admin/build/locale/string/edit/%'] = array(
    'title' => t('Edit string'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('locale_admin_string_edit', 5),
    'type' => MENU_CALLBACK,
  );
  $items['admin/build/locale/string/delete/%'] = array(
    'title' => t('Delete string'),
    'page callback' => 'locale_admin_string_delete',
    'page arguments' => array(5),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function locale_perm() {
  return array('administer locales');
}

/**
 * Implementation of hook_user().
 */
function locale_user($type, $edit, &$user, $category = NULL) {
  if ($type == 'form' && $category == 'account' && variable_get('language_count', 1) > 1 && variable_get('language_negotiation', LANGUAGE_NEGOTIATION_NONE) == LANGUAGE_NEGOTIATION_PATH) {
    $languages = language_list('enabled');
    $languages = $languages['1'];
    if ($user->language == '') {
      $default = language_default();
      $user->language = $default->language;
    }
    $names = array();
    foreach ($languages as $langcode => $language) {
      $names[$langcode] = t($language->name) .' ('. $language->native .')';
    }
    $form['locale'] = array('#type' => 'fieldset',
      '#title' => t('Interface language settings'),
      '#weight' => 1,
    );
    $form['locale']['language'] = array('#type' => 'radios',
      '#title' => t('Language'),
      '#default_value' => $user->language,
      '#options' => $names,
      '#description' => t('Selecting a different locale will change the interface language of the site.'),
    );
    return $form;
  }
}

/**
 * Implementation of hook_form_alter(). Adds language fields to forms.
 */
function locale_form_alter($form_id, &$form) {
  switch ($form_id) {
    case 'path_admin_edit':
      $form['language'] = array(
        '#type' => 'radios',
        '#title' => t('Language'),
        '#options' => array('' => t('All languages')) + locale_language_list('name'),
        '#default_value' => $form['#alias'] ? $form['#alias']['language'] : '',
        '#weight' => -10
      );
      break;
  }
}


// ---------------------------------------------------------------------------------
// Locale core functionality (needed on all page loads)

/**
 * Provides interface translation services.
 *
 * This function is called from t() to translate a string if needed.
 */
function locale($string) {
  global $language;
  static $locale_t;

  // Store database cached translations in a static var.
  if (!isset($locale_t)) {
    if (!($cache = cache_get('locale:'. $language->language, 'cache'))) {
      locale_refresh_cache();
      $cache = cache_get('locale:'. $language->language, 'cache');
    }
    $locale_t = unserialize($cache->data);
  }

  // We have the translation cached (if it is TRUE, then there is no
  // translation, so there is no point in checking the database)
  if (isset($locale_t[$string])) {
    $string = ($locale_t[$string] === TRUE ? $string : $locale_t[$string]);
  }

  // We do not have this translation cached, so get it from the DB.
  else {
    $result = db_query("SELECT s.lid, t.translation FROM {locales_source} s INNER JOIN {locales_target} t ON s.lid = t.lid WHERE s.source = '%s' AND t.language = '%s'", $string, $language->language);
    // Translation found
    if ($trans = db_fetch_object($result)) {
      if (!empty($trans->translation)) {
        $locale_t[$string] = $trans->translation;
        $string = $trans->translation;
      }
    }

    // Either we have no such source string, or no translation
    else {
      $result = db_query("SELECT lid, source FROM {locales_source} WHERE source = '%s'", $string);
      // We have no such translation
      if ($obj = db_fetch_object($result)) {
        if ($language) {
          db_query("INSERT INTO {locales_target} (lid, language, translation) VALUES (%d, '%s', '')", $obj->lid, $language->language);
        }
      }
      // We have no such source string
      else {
        db_query("INSERT INTO {locales_source} (location, source) VALUES ('%s', '%s')", request_uri(), $string);
        if ($language) {
          $lid = db_fetch_object(db_query("SELECT lid FROM {locales_source} WHERE source = '%s'", $string));
          db_query("INSERT INTO {locales_target} (lid, language, translation) VALUES (%d, '%s', '')", $lid->lid, $language->language);
        }
      }
      // Clear locale cache in DB
      cache_clear_all('locale:'. $language->language, 'cache');
    }
  }

  return $string;
}

/**
 * Refreshes database stored cache of translations.
 *
 * We only store short strings to improve performance and consume less memory.
 */
function locale_refresh_cache() {
  $languages = language_list('enabled');
  $languages = $languages['1'];

  foreach ($languages as $language) {
    $result = db_query("SELECT s.source, t.translation, t.language FROM {locales_source} s INNER JOIN {locales_target} t ON s.lid = t.lid WHERE t.language = '%s' AND LENGTH(s.source) < 75", $language->language);
    $t = array();
    while ($data = db_fetch_object($result)) {
      $t[$data->source] = (empty($data->translation) ? TRUE : $data->translation);
    }
    cache_set('locale:'. $language->language, serialize($t));
  }
}

/**
 * Returns plural form index for a specific number.
 *
 * The index is computed from the formula of this language.
 */
function locale_get_plural($count) {
  global $language;
  static $locale_formula, $plurals = array();

  if (!isset($plurals[$count])) {
    if (!isset($locale_formula)) {
      $locale_formula = $language->formula;
    }
    if ($locale_formula) {
      $n = $count;
      $plurals[$count] = @eval("return intval($locale_formula);");
      return $plurals[$count];
    }
    else {
      $plurals[$count] = -1;
      return -1;
    }
  }
  return $plurals[$count];
}


/**
 * Returns a language name
 */
function locale_language_name($lang) {
  static $list = NULL;
  if (!isset($list)) {
    $list = locale_language_list();
  }
  return ($lang && isset($list[$lang])) ? $list[$lang] : t('All');
}

/**
 * Returns array of language names
 *
 * @param $field
 *   'name' => names in current language, localized
 *   'native' => native names
 * @param $all
 *   Boolean to return all languages or only enabled ones
 */
function locale_language_list($field = 'name', $all = FALSE) {
  if ($all) {
    $languages = language_list();
  }
  else {
    $languages = language_list('enabled');
    $languages = $languages[1];
  }
  $list = array();
  foreach ($languages as $language) {
    $list[$language->language] = ($field == 'name') ? t($language->name) : $language->$field;
  }
  return $list;
}

// ---------------------------------------------------------------------------------
// Language management functionality (administration only)

/**
 * Page handler for the language management screen.
 */
function locale_admin_manage() {
  include_once './includes/locale.inc';
  return drupal_get_form('_locale_admin_manage_screen');
}

/**
 * User interface for the language deletion confirmation screen.
 */
function locale_admin_manage_delete_form($langcode) {
  include_once './includes/locale.inc';

  // Do not allow deletion of English locale.
  if ($langcode == 'en') {
    drupal_set_message(t('The English locale cannot be deleted.'));
    drupal_goto('admin/build/locale/language/overview');
  }

  $default = language_default();
  if ($default->language == $langcode) {
    drupal_set_message(t('The default language cannot be deleted.'));
    drupal_goto('admin/build/locale/language/overview');
  }

  // For other locales, warn user that data loss is ahead.
  $languages = language_list();

  if (!isset($languages[$langcode])) {
    drupal_not_found();
  }
  else {
    $form['langcode'] = array('#type' => 'value', '#value' => $langcode);
    return confirm_form($form, t('Are you sure you want to delete the language %name?', array('%name' => t($languages[$langcode]->name))), 'admin/build/locale/language/overview', t('Deleting a language will remove all data associated with it. This action cannot be undone.'), t('Delete'), t('Cancel'));
  }
}

/**
 * Process language deletion submissions.
 */
function locale_admin_manage_delete_form_submit($form_id, $form_values) {
  $languages = language_list();
  if (isset($languages[$form_values['langcode']])) {
    db_query("DELETE FROM {languages} WHERE language = '%s'", $form_values['langcode']);
    db_query("DELETE FROM {locales_target} WHERE language = '%s'", $form_values['langcode']);
    $message = t('The language %locale has been removed.', array('%locale' => t($languages[$form_values['langcode']]->name)));
    drupal_set_message($message);
    watchdog('locale', $message);
  }

  // Changing the locale settings impacts the interface:
  cache_clear_all('*', 'cache_page', TRUE);

  return 'admin/build/locale/language/overview';
}

/**
 * Page handler for the language addition screen
 */
function locale_admin_manage_add() {
  include_once './includes/locale.inc';
  return _locale_admin_manage_add_screen();
}

function locale_admin_manage_edit($langcode) {
  include_once './includes/locale.inc';
  return _locale_admin_manage_edit_screen($langcode);
}

function locale_admin_manage_configure() {
  include_once './includes/locale.inc';
  return drupal_get_form("locale_configure_language_form");
}

// ---------------------------------------------------------------------------------
// Gettext Portable Object import functionality (administration only)

/**
 * Page handler for the translation import screen
 */
function locale_admin_import() {
  include_once './includes/locale.inc';
  return drupal_get_form('_locale_admin_import');
}

// ---------------------------------------------------------------------------------
// Gettext Portable Object export functionality (administration only)

/**
 * Page handler for the translation export screen
 */
function locale_admin_export() {
  include_once './includes/locale.inc';
  return _locale_admin_export_screen();
}

// ---------------------------------------------------------------------------------
// String search and editing functionality (administration only)

/**
 * Page handler for the string search.
 */
function locale_string_search() {
  include_once './includes/locale.inc';
  $output = _locale_string_seek();
  $output .= drupal_get_form('_locale_string_seek_form');
  return $output;
}

/**
 * Display the string edit form.
 */
function locale_admin_string_edit($lid) {
  include_once './includes/locale.inc';
  return _locale_string_edit($lid);
}

/**
 * Process the string edit form.
 */
function locale_admin_string_edit_submit($form_id, $form_values) {
  include_once './includes/locale.inc';
  return _locale_string_edit_submit($form_id, $form_values);
}

/**
 * Delete a string.
 */
function locale_admin_string_delete($lid) {
  include_once './includes/locale.inc';
  _locale_string_delete($lid);
}
