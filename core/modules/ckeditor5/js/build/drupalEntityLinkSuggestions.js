!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CKEditor5=e():(t.CKEditor5=t.CKEditor5||{},t.CKEditor5.drupalEntityLinkSuggestions=e())}(globalThis,(()=>(()=>{var t={"ckeditor5/src/core.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/core.js")},"ckeditor5/src/typing.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/typing.js")},"ckeditor5/src/ui.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/ui.js")},"ckeditor5/src/utils.js":(t,e,i)=>{t.exports=i("dll-reference CKEditor5.dll")("./src/utils.js")},"dll-reference CKEditor5.dll":t=>{"use strict";t.exports=CKEditor5.dll}},e={};function i(n){var s=e[n];if(void 0!==s)return s.exports;var a=e[n]={exports:{}};return t[n](a,a.exports,i),a.exports}i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var n={};return(()=>{"use strict";i.d(n,{default:()=>m});var t=i("ckeditor5/src/core.js"),e=i("ckeditor5/src/ui.js");const s=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g,a=["https?","ftps?","mailto"];function r(t,e=a){const i=String(t),n=e.join("|");return function(t,e){const i=t.replace(s,"");return!!i.match(e)}(i,new RegExp(`${"^(?:(?:<protocols>):|[^a-z]|[a-z+.-]+(?:[^a-z+.:-]|$))".replace("<protocols>",n)}`,"i"))?i:"#"}var o=i("ckeditor5/src/typing.js"),l=i("ckeditor5/src/utils.js");class d extends t.Command{refresh(){const{model:t}=this.editor,{selection:e}=t.document;if(e.hasAttribute("data-entity-metadata"))return this.value=JSON.parse(e.getAttribute("data-entity-metadata")),void(this.isEnabled=t.schema.checkAttributeInSelection(e,"data-entity-metadata"));const i=e.getSelectedElement()||(0,l.first)(e.getSelectedBlocks());i&&i.hasAttribute("drupalLinkEntityMetadata")&&(this.value=JSON.parse(i.getAttribute("drupalLinkEntityMetadata")),this.isEnabled=t.schema.checkAttribute(i,"drupalLinkEntityMetadata"))}}class u extends t.Plugin{init(){const{editor:t}=this;t.commands.add("linkSuggestionMetadata",new d(t)),this.attrs=["data-entity-type","data-entity-uuid","data-entity-metadata"],this.blockLinkAttrs=["data-link-entity-type","data-link-entity-uuid","data-link-entity-metadata"],this.blockLinkAttrsToModel={"data-link-entity-type":"drupalLinkEntityType","data-link-entity-uuid":"drupalLinkEntityUuid","data-link-entity-metadata":"drupalLinkEntityMetadata"},this._allowAndConvertExtraAttributes(),this._removeExtraAttributesOnUnlinkCommandExecute(),this._refreshExtraAttributeValues(),this._addExtraAttributesOnLinkCommandExecute()}_allowAndConvertExtraAttributes(){const{editor:t}=this;t.model.schema.extend("$text",{allowAttributes:this.attrs}),this.attrs.forEach((e=>{t.conversion.for("downcast").attributeToElement({model:e,view:(t,{writer:i})=>{const n={};n[e]=t;const s=i.createAttributeElement("a",n,{priority:5});return i.setCustomProperty("link",!0,s),s}}),t.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{[e]:!0}},model:{key:e,value:t=>t.getAttribute(e)}})}))}_addExtraAttributesOnLinkCommandExecute(){const{editor:t}=this,e=t.commands.get("link");let i=!1;e.on("execute",((e,n)=>{if(i)return void(i=!1);e.stop(),i=!0;let s=[];n&&n[1]&&!n[1].entityLinkAttributes?(this.attrs.forEach((t=>{s[t]=e.source[t]})),n[1].entityLinkAttributes=s):s=n[1].entityLinkAttributes;const{model:a}=t,{selection:r}=a.document,l=n[n.length-1]||"",d=n[0];a.change((e=>{if(t.execute("link",...n),this.attrs.forEach((t=>{if(r.isCollapsed){let i=function(t,e,i){const n=e.getFirstPosition();return(0,o.findAttributeRange)(n,"linkHref",i,t)}(a,r,d);i=((t,i)=>{const s=function(t){let e="";for(const i of t.getItems()){if(!i.is("$text")&&!i.is("$textProxy"))return;e+=i.data}return e}(t);if(!s)return t;const a=i||s||n[0];return e.createRange(t.start,t.start.getShiftedBy(a.length))})(i,l),s[t]?e.setAttribute(t,s[t],i):e.removeAttribute(t,i),e.setSelection(i.end);const{plugins:u}=this.editor;u.has("TwoStepCaretMovement")?u.get("TwoStepCaretMovement")._handleForwardMovement():e.removeSelectionAttribute(t)}else{const i=a.schema.getValidRanges(r.getRanges(),t);for(const n of i)s[t]?e.setAttribute(t,s[t],n):e.removeAttribute(t,n)}})),r.getSelectedElement()&&["imageBlock","drupalMedia"].includes(r.getSelectedElement().name)){const t=r.getSelectedElement();this.blockLinkAttrs.forEach((i=>{s[i]?e.setAttribute(this.blockLinkAttrsToModel[i],s[i],t):e.removeAttribute(this.blockLinkAttrsToModel[i],t)}))}}))}),{priority:"high"})}_removeExtraAttributesOnUnlinkCommandExecute(){const{editor:t}=this,e=t.commands.get("unlink"),{model:i}=t,{selection:n}=i.document;let s=!1;e.on("execute",(e=>{s||(e.stop(),i.change((()=>{s=!0,t.execute("unlink"),s=!1,i.change((t=>{let e;this.attrs.forEach((s=>{e=n.isCollapsed?[(0,o.findAttributeRange)(n.getFirstPosition(),s,n.getAttribute(s),i)]:i.schema.getValidRanges(n.getRanges(),s);for(const i of e)t.removeAttribute(s,i)}))}))})))}),{priority:"high"})}_refreshExtraAttributeValues(){const{editor:t}=this,e=this.attrs,i=t.commands.get("link"),{model:n}=t,{selection:s}=n.document;e.forEach((t=>{i.set(t,null)})),n.document.on("change",(()=>{e.forEach((t=>{i[t]=s.getAttribute(t)}))}))}static get pluginName(){return"DrupalEntityLinkSuggestionsEditing"}}const c=jQuery;function p(t,e){const i=c('<li class="entity-link-suggestions-result-line">'),n=c('<div class="entity-link-suggestions-result-line-wrapper">');return n.append(`<span class="entity-link-suggestions-result-line--title">${e.label}</span>`),e.hasOwnProperty("description")&&n.append(`<span class="entity-link-suggestions-result-line--description">${e.description}</span>`),i.append(n).appendTo(t)}function h(t,e){const i={};e.forEach((t=>{const e=t.hasOwnProperty("group")?t.group:"";i.hasOwnProperty(e)||(i[e]=[]),i[e].push(t)})),Object.keys(i).forEach((e=>{const n=i[e];e.length&&t.append(`<li class="entity-link-suggestions-result-line--group ui-menu-divider">${e}</li>`),n.forEach((e=>{this.element.autocomplete("instance")._renderItemData(t,e)}))}))}class g extends t.Plugin{static get requires(){return[u]}init(){const{editor:t}=this;t.plugins.get("LinkUI")._createViews(),this._buttonViews=new e.ViewCollection,this._enableLinkAutocomplete(),this._handleExtraFormFieldSubmit(),this._handleDataLoadingIntoExtraFormField(),this._handleEntityLinkPreviews()}_handleEntityLinkPreviews(){const{editor:t}=this,e=t.commands.get("link"),i=t.commands.get("linkSuggestionMetadata"),n=t.plugins.get("LinkUI").toolbarView.items.first;n.unbind("href"),n.bind("href").toMany([e,i],"value",((e,i)=>i&&i.path&&i.path.startsWith("/")?`${drupalSettings.path.baseUrl}${i.path.substring(1)}`:e&&e.startsWith("/")?`${drupalSettings.path.baseUrl}${e.substring(1)}`:e&&r(e,t.config.get("link.allowedProtocols")))),n.unbind("label"),n.bind("label").toMany([e,i],"value",((e,i)=>{if(!i)return e||t.locale.t("This link has no URL");const n=i.group?` (${i.group})`:"";return`${i.label}${n.replace(" - )",")")}`}))}_enableLinkAutocomplete(){const{editor:t}=this,i=t.sourceElement.getAttribute("data-ckeditor5-host-entity-type"),n=t.sourceElement.getAttribute("data-ckeditor5-host-entity-langcode"),s=t.plugins.get("LinkUI").formView;let a=!1;s.extendTemplate({attributes:{class:["ck-vertical-form","ck-link-form_layout-vertical"]}});const r=new e.View;r.setTemplate({tag:"ul",children:this._buttonViews.map((t=>({tag:"li",children:[t],attributes:{class:["ck","ck-list__item"]}}))),attributes:{class:["ck","ck-reset","ck-list"]}}),s.children.add(r,1),t.plugins.get("ContextualBalloon").on("set:visibleView",((t,e,r)=>{if(r!==s||a)return;let o;!function(t,e){const{autocompleteUrl:i,selectHandler:n,closeHandler:s,openHandler:a,queryParams:r}=e,o={cache:{},ajax:{dataType:"json",jsonp:!1}},l={appendTo:t.closest(".ck-labeled-field-view"),source:function(t,e){const{cache:n}=o,{term:s}=t;if(n.hasOwnProperty(s))e(n[s]);else{const t=r;t.q=s,c.ajax(i,{success:function(t){n[s]=t.suggestions,e(t.suggestions)},data:t,...o.ajax})}},select:n,focus:()=>!1,search:()=>!l.isComposing,close:s,open:a,minLength:1,isComposing:!1},d=c(t).autocomplete(l),u=d.data("ui-autocomplete");u.widget().menu("option","items","> :not(.entity-link-suggestions-result-line--group)"),u._renderMenu=h,u._renderItem=p,d.autocomplete("widget").addClass("ck-reset_all-excluded entity-link-suggestions-ui-autocomplete"),d.on("click",(()=>{d.autocomplete("search",d[0].value)})),d.on("compositionstart.autocomplete",(()=>{l.isComposing=!0})),d.on("compositionend.autocomplete",(()=>{l.isComposing=!1}))}(s.urlInputView.fieldView.element,{autocompleteUrl:this.editor.config.get("drupalEntityLinkSuggestions").suggestionsUrl,queryParams:{hostEntityLangcode:n,hostEntityTypeId:i},selectHandler:(t,{item:e})=>{if(!e.path&&!e.href)throw`Missing path or href param. ${JSON.stringify(e)}`;if(e.entity_type_id||e.entity_uuid){if(!e.entity_type_id||!e.entity_uuid)throw`Missing entity type id and/or entity uuid. ${JSON.stringify(e)}`;this.set("entityType",e.entity_type_id),this.set("entityUuid",e.entity_uuid),this.set("entityMetadata",JSON.stringify(e))}else this.set("entityType",null),this.set("entityUuid",null),this.set("entityMetadata",null);if(s.hasOwnProperty("displayedTextInputView")&&""===s.displayedTextInputView.fieldView.element.value&&e.label){const t=document.createElement("span");t.innerHTML=e.label,s.displayedTextInputView.fieldView.value=t.textContent}return t.target.value=e.path??e.href,o=!0,!1},openHandler:()=>{o=!1},closeHandler:()=>{o=!1}}),a=!0}))}_handleExtraFormFieldSubmit(){const{editor:t}=this,e=t.plugins.get("LinkUI").formView,i=t.commands.get("link");this.listenTo(e,"submit",(()=>{i.once("execute",((t,e)=>{g._isValidHttpUrl(e[0])?e[1].entityLinkAttributes={"data-link-entity-type":"external"}:e[1].entityLinkAttributes={"data-entity-type":this.entityType,"data-entity-uuid":this.entityUuid,"data-entity-metadata":this.entityMetadata,"data-link-entity-type":this.entityType,"data-link-entity-uuid":this.entityUuid,"data-link-entity-metadata":this.entityMetadata}}),{priority:"highest"})}),{priority:"high"})}_handleDataLoadingIntoExtraFormField(){const{editor:t}=this,e=t.commands.get("link");this.bind("entityType").to(e,"data-entity-type"),this.bind("entityUuid").to(e,"data-entity-uuid"),this.bind("entityMetadata").to(e,"data-entity-metadata")}static _isValidHttpUrl(t){let e;try{e=new URL(t)}catch(t){return!1}return"https:"===e.protocol}static get pluginName(){return"DrupalEntityLinkSuggestions"}}const m={DrupalEntityLinkSuggestions:g}})(),n=n.default})()));